import{P as m}from"./phaser_vendor-D9yEWc94.js";import{h as C,g as f,_ as lt}from"./vendor-CiDEJBbE.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();var P=(i=>(i.Preload="PreloadScene",i.Scene1="Scene1",i.Scene2="Scene2",i.Scene3="Scene3",i.EndGame="EndGameScene",i.UI="UIScene",i))(P||{}),p=(i=>(i.BtnExit="btn_exit",i.BtnReset="btn_reset",i.BtnEraser="btn_eraser",i.HandHint="hand_hint",i.Decor="decor",i.So1="so1",i.Dice="dice",i.S1_Banner="banner_s2",i.S1_BannerText="text_banner_s2",i.S1_Board="board_s2",i.S1_Casau_Template="ca_sau_template",i.S1_Frame="frame",i.S1_Name="name",i.S1_Name_Bg="name_bg",i.S1_Outline="outline",i.S1_1="1",i.S1_Q1="q1",i.S1_Q2="q2",i.S2_Q1="s2_q1",i.S2_Q2="s2_q2",i.S3_Q1="s3_q1",i.S3_Q2="s3_q2",i.BtnS1_1="s1_btn_1",i.BtnS1_2="s1_btn_2",i.BtnS1_3="s1_btn_3",i.BtnS1_4="s1_btn_4",i.BtnS1_5="s1_btn_5",i.BtnS1_6="s1_btn_6",i.BtnS1_7="s1_btn_7",i.End_Icon="icon_end",i.End_BannerCongrat="banner_congrat",i))(p||{}),N=(i=>(i.BgmNen="bgm-nen",i))(N||{}),V=(i=>(i.LevelS1Config="level_1_config",i.LevelS2Config="level_2_config",i.LevelS3Config="level_3_config",i))(V||{});const A={PALETTE_DATA:[{key:p.BtnS1_1,color:1769216}],IDLE:{THRESHOLD:1e4,FADE_IN:800,SCALE:300,FADE_OUT:500},SCENE1:{UI:{BANNER_Y:.001,BOARD_OFFSET:.03},TIMING:{INTRO_DELAY:1e3,RESTART_INTRO:200,WIN_DELAY:2500,AUTO_FILL:100}},PAINT:{BRUSH_SIZE:100,WIN_PERCENT:.9,DEFAULT_COLOR:6202453}};class M{static getW(t){return t.scale.width}static getH(t){return t.scale.height}static pctX(t,e){return t.scale.width*e}static pctY(t,e){return t.scale.height*e}static centerObj(t,e){e.setPosition(t.scale.width/2,t.scale.height/2)}static calculateCenteredOffset(t,e){const n=t.textures.get(e).getSourceImage();if(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement){const a=n.width,o=n.height,r=document.createElement("canvas");r.width=a,r.height=o;const l=r.getContext("2d");if(!l)return{x:0,y:0};l.drawImage(n,0,0);const h=l.getImageData(0,0,a,o).data;let d=0,g=0,u=0;const v=[],_=4;for(let b=0;b<o;b+=_)for(let I=0;I<a;I+=_){const L=(b*a+I)*4;h[L+3]>50&&(d+=I,g+=b,u++,v.push({x:I,y:b}))}if(u===0||v.length===0)return{x:0,y:0};let E=Math.floor(d/u),R=Math.floor(g/u);const $=(R*a+E)*4,U=h[$+3],at=(b,I)=>{const T=[{dx:0,dy:-2},{dx:0,dy:2},{dx:-2,dy:0},{dx:2,dy:0},{dx:-2,dy:-2},{dx:2,dy:-2},{dx:-2,dy:2},{dx:2,dy:2}];for(const k of T){const F=b+k.dx,W=I+k.dy;if(F<0||F>=a||W<0||W>=o)return!1;const ct=(W*a+F)*4;if(h[ct+3]<=50)return!1}return!0};if(!U||U<=50){let b=1/0,I=v[0],L=!1;for(const T of v){const k=(T.x-E)**2+(T.y-R)**2;at(T.x,T.y)?L?k<b&&(b=k,I=T):(L=!0,b=k,I=T):L||k<b&&(b=k,I=T)}E=I.x,R=I.y}const rt=E-a/2,ot=R-o/2;return{x:rt,y:ot}}return{x:0,y:0}}}class ht{constructor(t,e){this.timer=0,this.isActive=!1,this.threshold=t,this.callback=e}start(){this.isActive=!0,this.timer=0}stop(){this.isActive=!1,this.timer=0}reset(){this.isActive&&(this.timer=0)}update(t){this.isActive&&(this.timer+=t,this.timer>this.threshold&&(this.callback(),this.timer=0))}}let Y=!0;function dt(i){const t=document.getElementById("bg-layer-a"),e=document.getElementById("bg-layer-b");if(!t||!e)return;const s=Y?t:e,n=Y?e:t,a=`url('${i}')`;s.style.backgroundImage!==a&&(n.style.backgroundImage=a,n.classList.add("visible"),s.classList.remove("visible"),Y=!Y)}class ut{constructor(t,e){this.brushColor=A.PAINT.DEFAULT_COLOR,this.brushSize=A.PAINT.BRUSH_SIZE,this.brushTexture="brush_circle",this.isErasing=!1,this.activeRenderTexture=null,this.activeHitArea=null,this.lastX=0,this.lastY=0,this.ignoreCameraId=0,this.partColors=new Map,this.partUncheckedMetrics=new Map,this.maskCache=new Map,this.CHECK_THRESHOLD=300,this.scene=t,this.onPartComplete=e,this.scene.input.topOnly=!1,this.helperCanvasPaint=document.createElement("canvas"),this.helperCanvasMask=document.createElement("canvas"),this.createBrushTexture()}createBrushTexture(){if(!this.scene.textures.exists(this.brushTexture)){const t=this.scene.textures.createCanvas(this.brushTexture,this.brushSize,this.brushSize);if(t){const e=t.context,s=e.createRadialGradient(this.brushSize/2,this.brushSize/2,0,this.brushSize/2,this.brushSize/2,this.brushSize/2);s.addColorStop(0,"rgba(255, 255, 255, 1)"),s.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=s,e.fillRect(0,0,this.brushSize,this.brushSize),t.refresh()}}}setColor(t){this.isErasing=!1,this.brushColor=t}setEraser(){this.isErasing=!0}setIgnoreCameraId(t){this.ignoreCameraId=t}isPainting(){return this.activeRenderTexture!==null}createPaintableLayer(t,e,s,n,a){const o=this.scene.make.image({x:t,y:e,key:s,add:!1}).setScale(n),r=o.createBitmapMask(),l=o.width*n,c=o.height*n,h=this.scene.add.renderTexture(t-l/2,e-c/2,l,c);h.clear().setAlpha(0),h.setOrigin(0,0).setDepth(10),h.setData("id",a),h.setData("key",s),h.setData("isFinished",!1),h.setData("mask",r),this.ignoreCameraId&&(h.cameraFilter=this.ignoreCameraId);const d=this.scene.add.image(t,e,s).setScale(n).setAlpha(.01).setDepth(50);return d.setInteractive({useHandCursor:!0,pixelPerfect:!0}),this.ignoreCameraId&&(d.cameraFilter=this.ignoreCameraId),d.setData("layer",h),d.setData("id",a),d.on("pointerdown",g=>{this.activeHitArea!==d&&(this.activeHitArea&&this.freezePart(this.activeHitArea),this.unfreezePart(d),this.activeHitArea=d);const u=d.getData("layer");if(u instanceof m.GameObjects.RenderTexture){if(!u.mask){const v=u.getData("mask");v&&u.setMask(v)}this.activeRenderTexture=u,this.lastX=g.x-u.x,this.lastY=g.y-u.y,this.paint(g,u)}}),d}handlePointerMove(t){t.isDown&&this.activeRenderTexture&&this.paint(t,this.activeRenderTexture)}handlePointerUp(){if(this.isErasing){this.activeRenderTexture=null;return}if(this.activeRenderTexture){const t=this.activeRenderTexture.getData("id");(this.partUncheckedMetrics.get(t)||0)>this.CHECK_THRESHOLD&&(this.checkProgress(this.activeRenderTexture),this.partUncheckedMetrics.set(t,0)),this.activeRenderTexture=null}}freezePart(t){const e=t.getData("layer");if(e instanceof m.GameObjects.RenderTexture){const s=t.getData("id"),n=`painted_tex_${s}`;this.scene.textures.exists(n)&&this.scene.textures.remove(n),e.saveTexture(n);const a=this.scene.add.image(e.x,e.y,n);a.setOrigin(0,0).setDepth(10);const o=e.getData("mask");o&&a.setMask(o),this.ignoreCameraId&&(a.cameraFilter=this.ignoreCameraId),a.setData("id",s),a.setData("key",e.getData("key")),a.setData("isFinished",e.getData("isFinished")),a.setData("mask",o),t.setData("layer",a),e.destroy()}}unfreezePart(t){const e=t.getData("layer");if(e instanceof m.GameObjects.Image){const s=e.width,n=e.height,a=e.x,o=e.y,r=this.scene.add.renderTexture(a,o,s,n);r.setOrigin(0,0).setDepth(10),e.clearMask(),r.draw(e,0,0);const l=e.getData("mask");l&&r.setMask(l),this.ignoreCameraId&&(r.cameraFilter=this.ignoreCameraId),r.setData("id",e.getData("id")),r.setData("key",e.getData("key")),r.setData("isFinished",e.getData("isFinished")),r.setData("mask",l),t.setData("layer",r),e.destroy()}}paint(t,e){const s=t.x-e.x,n=t.y-e.y,a=m.Math.Distance.Between(this.lastX,this.lastY,s,n);if(a<10)return;const o=e.getData("id"),r=this.partUncheckedMetrics.get(o)||0;this.partUncheckedMetrics.set(o,r+a);const l=this.brushSize*.65;let c=Math.ceil(a/l);c>50&&(c=50);const h=this.brushSize/2;for(let d=0;d<c;d++){const g=d/c,u=this.lastX+(s-this.lastX)*g,v=this.lastY+(n-this.lastY)*g;this.isErasing?e.erase(this.brushTexture,u-h,v-h):e.draw(this.brushTexture,u-h,v-h,1,this.brushColor)}this.isErasing?e.erase(this.brushTexture,s-h,n-h):(e.draw(this.brushTexture,s-h,n-h,1,this.brushColor),this.partColors.has(o)||this.partColors.set(o,new Set),this.partColors.get(o)?.add(this.brushColor)),this.lastX=s,this.lastY=n}checkProgress(t){if(t.getData("isFinished"))return;const e=t.getData("id"),s=t.getData("key");t.snapshot(n=>{if(!(n instanceof HTMLImageElement))return;const a=n.width,o=n.height,r=Math.floor(a/4),l=Math.floor(o/4),c=this.getRecycledContext(this.helperCanvasPaint,n,r,l);if(!c)return;const h=c.getImageData(0,0,r,l).data;let d=this.maskCache.get(e);if(!d){const _=this.scene.textures.get(s).getSourceImage(),E=this.getRecycledContext(this.helperCanvasMask,_,r,l);if(!E)return;d=E.getImageData(0,0,r,l).data,this.maskCache.set(e,d)}let g=0,u=0;for(let _=3;_<h.length;_+=4)d[_]>0&&(u++,h[_]>0&&g++);if((u>0?g/u:0)>A.PAINT.WIN_PERCENT){t.setData("isFinished",!0);const _=this.partColors.get(e)||new Set([this.brushColor]);this.onPartComplete(e,t,_),this.partColors.delete(e),this.partUncheckedMetrics.delete(e)}})}getRecycledContext(t,e,s,n){t.width=s,t.height=n;const a=t.getContext("2d");return a&&(a.clearRect(0,0,s,n),a.drawImage(e,0,0,s,n)),a}}const D="assets/audio/",z={"sfx-correct":{src:`${D}sfx/correct_answer.mp3`,volume:1},"sfx-correct_s2":{src:`${D}sfx/correct_color.mp3`,volume:1},"sfx-wrong":{src:`${D}sfx/wrong.mp3`,volume:.5},"sfx-click":{src:`${D}sfx/click.mp3`,volume:.5},"sfx-ting":{src:`${D}sfx/correct.mp3`,volume:.6},"voice-rotate":{src:`${D}prompt/rotate.mp3`,volume:.8},voice_intro_s2:{src:`${D}prompt/instruction.mp3`,volume:1},hint:{src:`${D}prompt/hint.mp3`,volume:1},complete:{src:`${D}sfx/complete.mp3`,volume:1},fireworks:{src:`${D}sfx/fireworks.mp3`,volume:1},applause:{src:`${D}sfx/applause.mp3`,volume:1}};class gt{constructor(){this.sounds={},this.isLoaded=!1,C.Howler.autoUnlock=!0,C.Howler.volume(1)}loadAll(){return this.isLoaded?Promise.resolve():new Promise(t=>{const e=Object.keys(z);let s=0;const n=e.length;if(n===0)return t();e.forEach(a=>{const o=z[a];this.sounds[a]=new C.Howl({src:[o.src],loop:o.loop||!1,volume:o.volume||1,html5:!0,onload:()=>{s++,s===n&&(this.isLoaded=!0,t())},onloaderror:(r,l)=>{const c=l instanceof Error?l.message:String(l);console.error(`[Howler Load Error] Key: ${a}, ID: ${r}, Msg: ${c}. Check file path: ${o.src}`),s++,s===n&&(this.isLoaded=!0,t())}})})})}play(t){if(!this.sounds[t]){const e=z[t];if(!e){console.warn(`[AudioManager] Sound ID not found in config: ${t}`);return}this.sounds[t]=new C.Howl({src:[e.src],loop:e.loop||!1,volume:e.volume||1,html5:!0,onloaderror:(s,n)=>{console.error(`[Howler Error] Load failed for ${t}:`,n)}})}return this.sounds[t].play()}stop(t){this.sounds[t]&&this.sounds[t].stop()}stopSound(t){this.sounds[t]&&this.sounds[t].stop()}stopAll(){C.Howler.stop()}stopAllVoicePrompts(){Object.keys(z).filter(e=>e.startsWith("prompt_")||e.startsWith("correct_answer_")).forEach(e=>{this.stopSound(e)})}get isUnlocked(){return C.Howler.ctx&&C.Howler.ctx.state==="running"}unlockAudio(){if(!C.Howler.usingWebAudio)return;const t=new C.Howl({src:["data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAAAAAA=="],volume:0,html5:!0});t.once("play",()=>{t.stop(),console.log("[Howler] Audio context unlocked manually.")}),C.Howler.ctx&&C.Howler.ctx.state!=="running"&&t.play()}getDuration(t){const e=this.sounds[t];return e?e.duration():(console.warn(`[AudioManager] Kh√¥ng t√¨m th·∫•y duration cho key: "${t}"`),0)}}const S=new gt;let y=null,G=!1,w=null,H=null,J=!1,q=0;const ft=1500;let O=null;const tt={breakpoint:768,message:"B√© H√£y Xoay Ngang M√†n H√¨nh ƒê·ªÉ Ch∆°i Nh√© üåà"};function K(i){return i.startsWith("drag_")||i.startsWith("q_")?1:i==="voice_need_finish"?2:i==="sfx_correct"||i==="sfx_wrong"?3:i==="voice_complete"||i==="voice_intro"||i==="voice_end"||i==="voice-rotate"?4:1}function X(i,t){if(G&&t!=="voice-rotate"){console.warn(`[Rotate] ƒêang overlay xoay m√†n h√¨nh, ch·ªâ ph√°t voice-rotate (b·ªè qua "${t}")`);return}if(t==="voice-rotate"){const a=Date.now();if(a-q<ft)return;(w==="instruction"||w==="cau_do"||w==="voice_intro_s2")&&(O=w),q=a,q=a;try{const r=S;typeof r.stopAll=="function"&&r.stopAll(),typeof r.stopAllVoicePrompts=="function"&&r.stopAllVoicePrompts()}catch(r){console.warn("[Rotate] stop all audio error:",r)}if(w=null,S.play("voice-rotate")===void 0){console.warn('[Rotate] Kh√¥ng ph√°t ƒë∆∞·ª£c audio key="voice-rotate" (Howler).');return}w="voice-rotate";return}const e=K(t),s=w?K(w):0;if(w===t||w&&s>e)return;if(w&&(S.stop(w),w=null),(t==="instruction"||t==="cau_do"||t==="voice_intro_s2")&&(O=null),S.play(t)===void 0){console.warn(`[Rotate] Kh√¥ng ph√°t ƒë∆∞·ª£c audio key="${t}" (Howler).`);return}w=t}function pt(){if(J)return;J=!0;const i=e=>{if(G){e.stopPropagation(),typeof e.stopImmediatePropagation=="function"&&e.stopImmediatePropagation(),e.preventDefault();try{X(null,"voice-rotate")}catch(s){console.warn("[Rotate] global pointer play voice-rotate error:",s)}}};["pointerdown","pointerup","click","touchstart","touchend","mousedown","mouseup"].forEach(e=>{window.addEventListener(e,i,{capture:!0,passive:!1})})}function et(){if(y)return;y=document.createElement("div"),y.id="rotate-overlay",y.style.position="fixed",y.style.inset="0",y.style.zIndex="2147483647",y.style.display="none",y.style.alignItems="center",y.style.justifyContent="center",y.style.textAlign="center",y.style.background="rgba(0, 0, 0, 0.6)",y.style.padding="16px",y.style.boxSizing="border-box",y.style.pointerEvents="auto";const i=document.createElement("div");i.style.background="white",i.style.borderRadius="16px",i.style.padding="16px 20px",i.style.maxWidth="320px",i.style.margin="0 auto",i.style.fontFamily='"Fredoka", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',i.style.boxShadow="0 8px 24px rgba(0,0,0,0.25)";const t=document.createElement("div");t.textContent=tt.message,t.style.fontSize="18px",t.style.fontWeight="700",t.style.marginBottom="8px",t.style.color="#222",i.appendChild(t),y.appendChild(i),document.body.appendChild(y)}function Q(){if(et(),!y)return;const i=window.innerWidth,e=window.innerHeight>i&&i<tt.breakpoint,s=G;G=e;const n=!s&&e,a=s&&!e;if(y.style.display=e?"flex":"none",n)try{X(null,"voice-rotate"),H&&H.scene&&H.scene.isActive()&&H.scene.pause()}catch(o){console.warn("[Rotate] auto play voice-rotate error:",o)}a&&(w==="voice-rotate"&&(S.stop("voice-rotate"),w=null),H&&H.scene&&H.scene.isPaused()&&H.scene.resume(),O&&(console.log(`[Rotate] Ph·ª•c h·ªìi voice b·ªã ng·∫Øt: ${O}`),O==="voice_intro_s2"&&H.restartIntro?H.restartIntro():X(null,O),O=null))}function mt(i){et(),pt(),Q(),window.addEventListener("resize",Q),window.addEventListener("orientationchange",Q)}function st(){w=null,O=null}function St(i){H=i}class yt extends m.Scene{constructor(){super(P.Scene1),this.unfinishedPartsMap=new Map,this.finishedParts=new Set,this.totalParts=0,this.score=0,this.isIntroActive=!1,this.isWaitingForIntroStart=!0,this.activeHintTween=null,this.activeHintTarget=null}get handHint(){return this.scene.get(P.UI)?.handHint}init(t){this.unfinishedPartsMap.clear(),this.finishedParts.clear(),this.totalParts=0,this.score=0,t?.isRestart?(this.isWaitingForIntroStart=!1,t.fromEndGame||f.retryFromStart()):this.isWaitingForIntroStart=!0}create(){if(it(),this.setupSystem(),this.setupBackgroundAndAudio(),this.createUI(),this.scene.launch(P.UI,{paintManager:this.paintManager,sceneKey:P.Scene1}),this.createLevel(),f.setTotal(1),window.irukaGameState={startTime:Date.now(),currentScore:0},B.score(this.score,0),B.progress({levelIndex:0,total:1}),f.startQuestionTimer(),this.setupInput(),this.events.on("wake",()=>{this.idleManager.reset(),this.input.keyboard&&(this.input.keyboard.enabled=!0)}),!this.isWaitingForIntroStart){const t=this.sound;t.context&&t.context.state==="suspended"&&t.context.resume(),setTimeout(()=>{this.playIntroSequence()},500)}}update(t,e){!this.paintManager.isPainting()&&!this.isIntroActive&&this.finishedParts.size<this.totalParts&&this.idleManager.update(e),this.fpsCounter&&this.fpsCounter.update()}shutdown(){this.stopIntro(),this.paintManager=null,this.scene.stop(P.UI),this.bgm&&this.bgm.stop()}setupSystem(){st(),window.gameScene=this,St(this),this.paintManager=new ut(this,(t,e,s)=>{this.handlePartComplete(t,e,s)}),this.idleManager=new ht(A.IDLE.THRESHOLD,()=>this.showHint())}setupInput(){this.input.on("pointermove",t=>{this.paintManager.handlePointerMove(t),this.paintManager.isPainting()&&(this.idleManager.reset(),this.stopIntro(),this.stopActiveHint())}),this.input.on("pointerup",()=>this.paintManager.handlePointerUp()),this.input.on("pointerdown",()=>{if(this.isWaitingForIntroStart){this.isWaitingForIntroStart=!1;const t=this.sound;t.context&&t.context.state==="suspended"&&t.context.resume(),this.playIntroSequence();return}this.idleManager.reset(),this.stopIntro(),this.stopActiveHint()})}setupBackgroundAndAudio(){dt("assets/images/bg/background.jpg"),this.sound.get(N.BgmNen)&&this.sound.stopByKey(N.BgmNen),this.bgm=this.sound.add(N.BgmNen,{loop:!0,volume:.25}),this.bgm.play()}createUI(){const t=A.SCENE1.UI,e=M.pctX(this,.5),n=this.textures.get(p.S1_Banner).getSourceImage().height*.7+M.pctY(this,t.BOARD_OFFSET),a=this.add.image(e,n,p.S1_Board).setOrigin(.5,0).setScale(.7).setDepth(0),o=a.displayHeight*.7;this.add.rectangle(a.x,a.y+a.displayHeight/2,5,o,0).setOrigin(.5,.5).setDepth(1)}createLevel(){const t=this.cache.json.get(V.LevelS1Config);t&&t.items&&Array.isArray(t.items)?t.items.forEach((e,s)=>{let n={...e};e.type&&t.definitions&&t.definitions[e.type]&&(n={...t.definitions[e.type],...e}),this.spawnCharacter(n,s)}):t&&(t.parts?this.spawnCharacter(t,0):Object.values(t).forEach((e,s)=>{e&&e.parts&&this.spawnCharacter(e,s)}))}spawnCharacter(t,e=0){const s=M.pctX(this,t.baseX_pct),n=M.pctY(this,t.baseY_pct);if(t.isStatic){this.add.image(s,n,t.outlineKey).setScale(t.baseScale).setDepth(900);return}t.parts.forEach((a,o)=>{const r=`${e}_${a.key}_${o}`,l=s+a.offsetX,c=n+a.offsetY,h=this.paintManager.createPaintableLayer(l,c,a.key,a.scale,r),d=M.calculateCenteredOffset(this,a.key);let g=d.x,u=d.y;h.setData("hintX",g),h.setData("hintY",u),h.setData("originScale",a.scale),typeof t.ans<"u"&&h.setData("isCorrectAnswer",t.ans),a.hintPoints&&Array.isArray(a.hintPoints)&&h.setData("hintPoints",a.hintPoints),this.unfinishedPartsMap.set(r,h),this.totalParts++}),this.add.image(s,n,t.outlineKey).setScale(t.baseScale).setDepth(900).setInteractive({pixelPerfect:!0})}drawDebugAxes(t){const e=this.add.graphics();e.setDepth(1e3);const s=t.x,n=t.y,a=t.displayWidth,o=t.displayHeight;e.lineStyle(2,16711680,1),e.beginPath(),e.moveTo(s-a/2,n),e.lineTo(s+a/2,n),e.strokePath(),e.lineStyle(2,65280,1),e.beginPath(),e.moveTo(s,n-o/2),e.lineTo(s,n+o/2),e.strokePath(),e.fillStyle(255,1),e.fillCircle(s,n,4);const r=50,l=5;for(let c=r;c<=a/2;c+=r)this.drawTick(e,s+c,n,l,16711680,c.toString()),this.drawTick(e,s-c,n,l,16711680,(-c).toString());for(let c=r;c<=o/2;c+=r)this.drawTick(e,s,n+c,l,65280,c.toString()),this.drawTick(e,s,n-c,l,65280,(-c).toString())}drawTick(t,e,s,n,a,o){t.lineStyle(1,a,1),t.beginPath(),t.moveTo(e-2,s-2),t.lineTo(e+2,s+2),t.moveTo(e+2,s-2),t.lineTo(e-2,s+2),t.strokePath(),this.add.text(e,s,o,{fontSize:"9px",color:"#ffffff",backgroundColor:"#000000AA"}).setOrigin(.5).setDepth(1001)}drawHintDebug(t,e){const s=this.add.graphics();s.setDepth(1001);const n=t.x,a=t.y,o=t.getData("originScale")||1;e.forEach(r=>{const l=n+r.x*o,c=a+r.y*o;s.fillStyle(16776960,1),s.fillCircle(l,c,5),this.add.text(l+5,c+5,`(${r.x}, ${r.y})`,{fontSize:"10px",color:"#ffff00",backgroundColor:"#000000"}).setDepth(1002)})}handlePartComplete(t,e,s){if(this.unfinishedPartsMap.get(t)?.getData("isCorrectAnswer")===!1){f.recordWrong(),console.log("WRONG ANSWER!"),S.play("sfx-wrong"),e.clear(),e.setData("isFinished",!1),this.tweens.add({targets:e,x:"+=10",duration:50,yoyo:!0,repeat:3});return}if(this.finishedParts.add(t),f.recordCorrect({scoreDelta:1}),this.score+=1,window.irukaGameState.currentScore=this.score,B.score(this.score,1),B.progress({levelIndex:0,score:this.score}),f.finishQuestionTimer(),s.size===1){const r=s.values().next().value||0;e.setBlendMode(m.BlendModes.NORMAL),e.fill(r)}else console.log("Multi-color artwork preserved!");this.unfinishedPartsMap.delete(t),S.stopAll(),S.play("sfx-ting"),this.tweens.add({targets:e,alpha:.8,yoyo:!0,duration:A.SCENE1.TIMING.AUTO_FILL,repeat:2});let o=0;if(this.unfinishedPartsMap.forEach(r=>{r.getData("isCorrectAnswer")===!0&&o++}),o===0){console.log("WIN!"),f.finalizeAttempt(),B.requestSave({score:this.score,levelIndex:0}),B.progress({levelIndex:0,total:1,score:this.score}),S.play("sfx-correct_s2");const r=this.scene.get(P.UI);r&&(r.hidePalette&&r.hidePalette(),r.hideBanners&&r.hideBanners()),this.time.delayedCall(A.SCENE1.TIMING.WIN_DELAY,()=>{this.scene.start(P.EndGame)})}}restartIntro(){this.stopIntro(),this.time.delayedCall(A.SCENE1.TIMING.RESTART_INTRO,()=>this.playIntroSequence())}playIntroSequence(){this.isIntroActive=!0,X(null,"voice_intro_s2"),this.time.delayedCall(A.SCENE1.TIMING.INTRO_DELAY,()=>{this.isIntroActive&&this.runHandTutorial()})}stopIntro(){this.isIntroActive=!1,this.idleManager.start(),this.handHint&&this.handHint.setAlpha(0).setPosition(-200,-200)}runHandTutorial(){if(!this.isIntroActive)return;const t=Array.from(this.unfinishedPartsMap.values());if(t.sort((a,o)=>a.x-o.x),t.length===0||!this.handHint)return;const e=M.getW(this)+200,s=M.getH(this)+200;this.handHint.setDepth(2e3).setAlpha(1).setScale(.7),this.handHint.setPosition(e,s),this.handHint.setOrigin(0,0);const n=[];t.forEach((a,o)=>{const r=a.getData("hintX")||0,l=a.getData("hintY")||0,c=a.getData("originScale")||1,h=a.x+r*c,d=a.y+l*c;n.push({x:h,y:d,duration:o===0?800:500,ease:"Power2"}),n.push({x:h+40,y:d+20,duration:200,yoyo:!0,repeat:3,ease:"Sine.easeInOut"})}),n.push({alpha:0,duration:500,delay:200,onComplete:()=>{this.handHint?.setPosition(e,s)}}),this.tweens.chain({targets:this.handHint,tweens:n,onComplete:()=>{this.isIntroActive&&this.time.delayedCall(1500,()=>this.runHandTutorial())}})}showHint(){f.addHint();const t=Array.from(this.unfinishedPartsMap.values());if(t.length===0)return;const e=t[Math.floor(Math.random()*t.length)];S.play("hint");const s=A.IDLE;this.activeHintTarget=e,this.activeHintTween=this.tweens.add({targets:e,alpha:{from:.01,to:.8},scale:{from:e.getData("originScale"),to:e.getData("originScale")*1.005},duration:s.FADE_IN,yoyo:!0,repeat:2,onComplete:()=>{this.activeHintTween=null,this.activeHintTarget=null,this.idleManager.reset()}});const n=e.getData("hintX")||0,a=e.getData("hintY")||0,o=e.getData("originScale")||1;let r=e.x+n*o,l=e.y+a*o;if(!this.handHint)return;this.handHint.setOrigin(0,0);const c=e?.getData("hintPoints");let h=r,d=l;const g=[];if(c&&c.length>0){const u=e?.x||0,v=e?.y||0,_=c[0];h=u+_.x*o,d=v+_.y*o,g.push({alpha:1,x:h,y:d,duration:s.FADE_IN}),g.push({scale:.5,duration:s.SCALE,yoyo:!0,repeat:3});for(let E=1;E<c.length;E++){const R=c[E],$=u+R.x*o,U=v+R.y*o;g.push({x:$,y:U,duration:s.SCALE*2}),g.push({scale:.5,duration:s.SCALE,yoyo:!0,repeat:3})}g.push({alpha:0,duration:s.FADE_OUT})}else h=r,d=l,g.push({alpha:1,x:r,y:l,duration:s.FADE_IN}),g.push({scale:.5,duration:s.SCALE,yoyo:!0,repeat:3}),g.push({alpha:0,duration:s.FADE_OUT});this.handHint.setPosition(h,d).setAlpha(0).setScale(.7),this.tweens.chain({targets:this.handHint,tweens:g})}stopActiveHint(){this.activeHintTween&&(this.activeHintTween.stop(),this.activeHintTween=null),this.activeHintTarget&&(this.tweens.killTweensOf(this.activeHintTarget),this.activeHintTarget.setAlpha(.01),this.activeHintTarget.setScale(this.activeHintTarget.getData("originScale")),this.activeHintTarget=null),this.handHint&&(this.tweens.killTweensOf(this.handHint),this.handHint.setAlpha(0).setPosition(-200,-200))}}class wt extends m.Scene{constructor(){super(P.Preload)}preload(){this.load.image(p.BtnExit,"assets/images/ui/btn_exit.png"),this.load.image(p.BtnReset,"assets/images/ui/btn_reset.png"),this.load.image(p.HandHint,"assets/images/ui/hand.png"),this.load.image(p.So1,"assets/images/ui/so1.png"),this.load.image(p.Dice,"assets/images/ui/dice.png"),this.load.image(p.S1_Banner,"assets/images/S1/banner.png"),this.load.image(p.S1_BannerText,"assets/images/S1/questionTitle.png"),this.load.image(p.S1_Board,"assets/images/bg/board_scene_2.png"),this.load.image(p.S1_Outline,"assets/images/S1/outline.png"),this.load.image(p.S1_1,"assets/images/S1/1.png"),this.load.image(p.S1_Q1,"assets/images/S1/q1.png"),this.load.image(p.S1_Q2,"assets/images/S1/q2.png"),this.load.json(V.LevelS1Config,"assets/data/level_s1_config.json"),this.load.image(p.End_Icon,"assets/images/ui/icon_end.png"),this.load.image(p.End_BannerCongrat,"assets/images/bg/banner_congrat.png"),this.load.audio(N.BgmNen,"assets/audio/sfx/nhac_nen.mp3")}create(){this.scene.start(P.Scene1)}}class vt extends m.Scene{constructor(){super(P.UI),this.paletteButtons=[]}init(t){this.paintManager=t.paintManager,this.sceneKey=t.sceneKey,this.paletteButtons=[]}create(){this.createUI()}createUI(){const t=A.SCENE1.UI,e=M.pctX(this,.5),s=M.pctY(this,t.BANNER_Y);M.pctX(this,t.BOARD_OFFSET);let n=p.S1_Banner,a=p.S1_BannerText;this.bannerImage=this.add.image(e,s,n).setScale(.8,.7).setOrigin(.5,-.1),this.bannerText=this.add.image(e,s,a).setScale(.9).setOrigin(.5,-.7),this.so1Image=this.add.image(e*.38,s+180,p.So1).setScale(1).setOrigin(.5,-.1),this.diceImage=this.add.image(e*.5,s+170,p.Dice).setScale(1).setOrigin(.5,-.1),this.handHint=this.add.image(0,0,p.HandHint).setDepth(2e3).setAlpha(0).setScale(.7),this.createPalette()}createPalette(){const t=A.PALETTE_DATA;t.length>0&&this.paintManager.setColor(t[0].color)}updatePaletteVisuals(t){this.paletteButtons.forEach(e=>e.setScale(.7).setAlpha(.8)),t.setScale(.9).setAlpha(1)}hidePalette(){this.tweens.add({targets:this.paletteButtons,scale:0,alpha:0,duration:500,ease:"Back.In"})}hideBanners(){this.bannerImage&&this.bannerImage.destroy(),this.bannerText&&this.bannerText.destroy(),this.decorImage&&this.decorImage.destroy(),this.so1Image&&this.so1Image.destroy(),this.diceImage&&this.diceImage.destroy()}}class _t extends m.Scene{constructor(){super("EndGameScene"),this.containerEl=null}preload(){this.load.image("icon","assets/images/ui/icon_end.png"),this.load.image("banner_congrat","assets/images/bg/banner_congrat.png"),this.load.image("btn_reset","assets/images/ui/btn_reset.png"),this.load.image("btn_exit","assets/images/ui/btn_exit.png")}create(){st();const t=this.scale.width,e=this.scale.height;if(S.loadAll(),S.play("complete"),this.time.delayedCall(1500,()=>{S.play("fireworks"),S.play("applause")}),this.add.image(t/2,e/2-e*.12,"banner_congrat").setOrigin(.5).setDepth(100).setDisplaySize(t*.9,e*.9),this.textures.exists("icon")){const r=this.add.image(t/2,e/2-150,"icon");r.setScale(.5),r.setDepth(1005),this.tweens.add({targets:r,y:r.y-10,duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:r,angle:{from:-5,to:5},duration:600,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}const s=Math.min(t,e)/1280,n=250*s,a=this.add.image(t/2-n,e/2+e*.2,"btn_reset").setOrigin(.5).setScale(s).setDepth(101).setInteractive({useHandCursor:!0});a.on("pointerdown",()=>{this.time.removeAllEvents(),this.sound.stopAll(),S.stopAll(),S.play("sfx-click"),this.stopConfetti(),it(),f.retryFromStart(),this.scene.start("Scene1",{isRestart:!0,fromEndGame:!0})});const o=this.add.image(t/2+n,e/2+e*.2,"btn_exit").setOrigin(.5).setScale(s).setDepth(101).setInteractive({useHandCursor:!0});o.on("pointerdown",()=>{S.play("sfx-click"),S.stopAll(),this.stopConfetti();const r=window.irukaGameState||{};r.startTime&&Date.now()-r.startTime,B.complete({timeMs:Date.now()-(window.irukaGameState?.startTime??Date.now()),extras:{reason:"user_exit",stats:f.prepareSubmitData()}})}),[a,o].forEach(r=>{r.on("pointerover",()=>r.setScale(s*1.1)),r.on("pointerout",()=>r.setScale(s))}),nt(),this.createConfettiEffect()}createConfettiEffect(){const t=this.cameras.main.width,e=[16739179,5164484,16770669,9822675,15958401,11179738],s=["circle","rect"];this.confettiEvent=this.time.addEvent({delay:100,callback:()=>{if(this.scene.isActive())for(let n=0;n<3;n++)this.createConfettiPiece(m.Math.Between(0,t),-20,m.Utils.Array.GetRandom(e),m.Utils.Array.GetRandom(s))},loop:!0})}createConfettiPiece(t,e,s,n){let a;n==="circle"?a=this.add.circle(t,e,m.Math.Between(4,8),s,1):a=this.add.rectangle(t,e,m.Math.Between(6,12),m.Math.Between(10,20),s,1),a.setDepth(999),a.setRotation(m.Math.Between(0,360)*Math.PI/180);const o=m.Math.Between(3e3,5e3),r=this.cameras.main.height+50,l=m.Math.Between(-100,100);this.tweens.add({targets:a,y:r,x:t+l,rotation:a.rotation+m.Math.Between(2,4)*Math.PI,duration:o,ease:"Linear",onComplete:()=>a.destroy()}),this.tweens.add({targets:a,alpha:{from:1,to:.3},duration:o,ease:"Cubic.easeIn"})}stopConfetti(){this.confettiEvent&&(this.confettiEvent.remove(!1),this.confettiEvent=void 0)}}function bt(){const t=(new URLSearchParams(window.location.search).get("e2e")||"").toLowerCase();return t==="1"||t==="true"}function j(i,t=1){const e=Number(i);return!Number.isFinite(e)||e<=0?t:Math.floor(e)}function It(i){if(!bt())return;const t=lt;t?.enable&&(t.enable(),window.__irukaSpy=t);const e=performance.now();window.__irukaTest={setTotal(s){f.setTotal(s)},startQ(s=1){for(let n=0;n<s;n++)f.startQuestionTimer()},finishQ(s=1){for(let n=0;n<s;n++)f.finishQuestionTimer()},makeWrong(s=1){s=j(s,1);for(let n=0;n<s;n++)f.recordWrong()},makeCorrect(s=1){s=j(s,1);for(let a=0;a<s;a++)f.recordCorrect({scoreDelta:1});const n=f.getStatsSnapshot();i.score(n.finalScore)},useHint(s=1){s=j(s,1);for(let n=0;n<s;n++)f.addHint()},finish(){f.finalizeAttempt();const s=f.prepareSubmitData(),n=Math.round(performance.now()-e);i.complete({score:s.finalScore,timeMs:n,extras:s})},snapshot(){return{stats:f.getStatsSnapshot(),submit:f.prepareSubmitData(),spySummary:t?.getSummary?.()}}}}function xt(i,t){const e=document.getElementById("game-container");e&&(e.style.width=`${i}px`,e.style.height=`${t}px`),x&&x.scale.resize(i,t)}function At(i){if(!x)return;x.scene.getScenes(!0)[0]?.applyHubState?.(i)}function Et(){const t=new URLSearchParams(window.location.search).get("hubOrigin");if(t)return t;try{const e=document.referrer;if(e)return new URL(e).origin}catch{}return"*"}const B=f.createGameSdk({hubOrigin:Et(),onInit(i){It(B),B.ready({capabilities:["resize","score","complete","save_load","set_state","stats","hint"]})},onStart(){x&&(x.scene.resume("Scene1"),x.scene.resume("EndGameScene"))},onPause(){x&&x.scene.pause("Scene1")},onResume(){x&&x.scene.resume("Scene1")},onResize(i){xt(i.width,i.height)},onSetState(i){At(i)},onQuit(){f.finalizeAttempt("quit"),B.complete({timeMs:Date.now()-(window.irukaGameState?.startTime??Date.now()),extras:{reason:"hub_quit",stats:f.prepareSubmitData()}})}});let x;const Ct={type:m.AUTO,width:1920,height:1080,parent:"game-container",scene:[wt,yt,_t,vt],backgroundColor:"#ffffff",scale:{mode:m.Scale.FIT,autoCenter:m.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{debug:!1}},render:{transparent:!0}};x=new m.Game(Ct);function it(){const i=document.getElementById("btn-reset");i&&(i.style.display="block")}function nt(){const i=document.getElementById("btn-reset");i&&(i.style.display="none")}function Z(){const i=document.getElementById("btn-reset");if(!i)return;const e=window.innerHeight/9;i.style.width=`${e}px`,i.style.height=`${e}px`}function Dt(){const i=document.getElementById("btn-reset");i&&(i.onclick=()=>{console.log("Restart button clicked."),x.sound.stopByKey("bgm-nen"),S.stopAll();try{S.play("sfx-click")}catch(t){console.error(t)}window.gameScene&&window.gameScene.scene&&(window.gameScene.scene.stop(),window.gameScene.scene.start("Scene1",{isRestart:!0})),nt()})}mt();Dt();Z();window.addEventListener("resize",Z);window.addEventListener("orientationchange",Z);document.getElementById("btn-reset")?.addEventListener("sfx-click",()=>{window.gameScene?.scene.restart()});
