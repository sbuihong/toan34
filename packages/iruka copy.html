<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Iruka GameHub Simulator</title>
    <style>
      :root{ --b:#ddd; --bg:#0b1020; --fg:#d7e1ff; --muted:#666; }
      *{ box-sizing:border-box; }

      html, body { height:100%; }

      body{
        margin:0;
        font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        min-height: 100vh;

        /* ‚úÖ Responsive height: kh√¥ng ƒëo√°n header 56px n·ªØa */
        display:flex;
        flex-direction:column;
      }

      header{
        position:sticky; top:0; z-index:10;
        display:flex;
        gap:8px;
        align-items:center;

        /* ‚úÖ wrap cho mobile */
        flex-wrap:wrap;

        padding:10px 12px;
        border-bottom:1px solid var(--b);
        background:#fff;
      }

      input, select, button, textarea{ font:inherit; }
      input, select{ padding:8px 10px; border:1px solid #ccc; border-radius:10px; }
      button{ padding:8px 12px; border:1px solid #ccc; border-radius:10px; background:#fff; cursor:pointer; }
      button:active{ transform: translateY(1px); }

      /* ‚úÖ main t·ª± co gi√£n theo body flex */
      main{
        flex:1;
        min-height:0; /* quan tr·ªçng ƒë·ªÉ overflow ho·∫°t ƒë·ªông ƒë√∫ng */
        display:grid;
        grid-template-columns: 1fr 520px;
      }

      #stageWrap{
        position:relative;
        background:#000;

        /* ‚úÖ tr√°nh tr√†n tr√™n mobile */
        overflow:hidden;
      }

      iframe{ width:100%; height:100%; border:0; background:#000; display:block; }

      aside{
        border-left:1px solid var(--b);
        padding:12px;
        overflow:auto;
        background:#fafafa;
      }

      .card{ background:#fff; border:1px solid var(--b); border-radius:14px; padding:10px; margin-bottom:10px; }
      .card h3{ margin:0 0 8px 0; font-size:14px; }
      .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .muted{ color:var(--muted); font-size:12px; line-height:1.4; }
      textarea{ width:100%; min-height:150px; padding:10px; border:1px solid #ccc; border-radius:12px; }
      pre{ margin:0; background: var(--bg); color: var(--fg); padding:10px; border-radius:14px; overflow:auto; min-height:220px; }
      code.k{ background:#f3f3f3; padding:2px 6px; border-radius:8px; }
      .kv{ font-size:12px; display:grid; grid-template-columns: 140px 1fr; gap:6px; }
      .ok{ color:#0a7a2f; }
      .bad{ color:#b30000; }
      .pill{ font-size:12px; padding:2px 10px; border:1px solid #ccc; border-radius:999px; }

      /* overlays */
      .overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:50; }
      .overlay.show{ display:flex; }
      .modal{
        width:min(560px, 92vw);
        background:#fff; border-radius:18px; padding:14px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      }
      .modal h2{ margin:0 0 8px 0; font-size:18px; }
      .modal p{ margin:0 0 10px 0; white-space:pre-wrap; }
      .resultGrid{
        display:grid;
        grid-template-columns: 180px 1fr;
        gap:6px 10px;
        font-size:13px;
      }
      .resultGrid .k{ color: var(--muted); }
      .resultGrid .v{ font-weight:600; color:#111; }

      details.rawJson{ margin-top:10px; }
      details.rawJson summary{
        cursor:pointer;
        user-select:none;
        font-size:13px;
        color:#111;
      }
      details.rawJson pre{
        margin-top:8px;
        max-height:260px;
      }

      /* ===========================
        ‚úÖ Responsive breakpoints
        =========================== */

      @media (max-width: 900px){
        /* header: url full h√†ng, c√°c control xu·ªëng h√†ng */
        #url{ flex: 1 1 100%; min-width:0; }
        #loadBtn, #reloadBtn{ flex: 0 0 auto; }
        #originMode{ flex: 1 1 140px; }
        #allowedOrigin{ flex: 1 1 220px; width:auto !important; min-width:0; }

        /* main: 1 c·ªôt, game tr√™n - panel d∆∞·ªõi */
        main{
          grid-template-columns: 1fr;
          grid-template-rows: minmax(46vh, 56vh) 1fr;
        }

        aside{
          border-left:0;
          border-top:1px solid var(--b);
          padding:10px;
          overflow:auto;
          -webkit-overflow-scrolling: touch;
        }

        .kv{ grid-template-columns: 120px 1fr; }
        pre{ min-height: 180px; }
      }

      @media (max-width: 480px){
        header{ padding:8px 10px; gap:6px; }
        input, select{ padding:7px 9px; border-radius:10px; }
        button{ padding:7px 10px; border-radius:10px; }

        .card{ padding:9px; border-radius:12px; }
        .kv{ grid-template-columns: 110px 1fr; }
        textarea{ min-height: 120px; }
        pre{ min-height: 160px; border-radius:12px; }
      }

      /* ===== Toggle panel (aside) ===== */
      body.panel-collapsed main{
        grid-template-columns: 1fr;   /* game full */
      }
      body.panel-collapsed aside{
        display:none;                 /* ·∫©n panel */
      }

      /* Khi mobile ƒëang d√πng layout 1 c·ªôt (2 h√†ng), n·∫øu collapse th√¨ ch·ªâ c√≤n game */
      @media (max-width: 900px){
        body.panel-collapsed main{
          grid-template-rows: 1fr;
        }
      }

      /* (Tu·ª≥ ch·ªçn) l√†m n√∫t Panel nh√¨n g·ªçn h∆°n */
      #togglePanelBtn{
        white-space:nowrap;
      }
    </style>
  </head>

  <body>
    <header>
      <span class="pill">GameHub</span>
      <input id="url" style="flex:1" />
      <button id="loadBtn">Load</button>
      <button id="reloadBtn">Reload</button>
      <button id="togglePanelBtn" aria-expanded="true" title="ƒê√≥ng/m·ªü panel">Panel ‚óÄ</button>

      <select id="originMode">
        <option value="any">Origin: *</option>
        <option value="lock">Origin: lock</option>
      </select>
      <input id="allowedOrigin" style="width:220px" placeholder="http://localhost:5173" />
    </header>

    <main>
      <div id="stageWrap">
        <iframe id="gameFrame" allow="microphone *; autoplay *; camera *; display-capture *; media *" allowfullscreen title="Game iframe"></iframe>

        <div id="loadingOverlay" class="overlay">
          <div class="modal">
            <h2>Hub Loading‚Ä¶</h2>
            <p class="muted">M√¥ ph·ªèng overlay loading c·ªßa hub.</p>
            <div class="row">
              <button id="loadingOffBtn">T·∫Øt</button>
            </div>
          </div>
        </div>

        <div id="rotateOverlay" class="overlay">
          <div class="modal">
            <h2>Xoay m√†n h√¨nh</h2>
            <p class="muted">M√¥ ph·ªèng rotate overlay c·ªßa hub.</p>
            <div class="row">
              <button id="rotateOffBtn">T·∫Øt</button>
            </div>
          </div>
        </div>

        <div id="resultOverlay" class="overlay">
          <div class="modal">
            <h2 id="resultTitle">K·∫øt qu·∫£</h2>
            <div id="resultBody"></div>
            <div class="row">
              <button id="resultCloseBtn">ƒê√≥ng</button>
              <button id="resultReplayBtn">Replay ‚Üí game</button>
              <button id="resultNextBtn">Next ‚Üí game</button>
            </div>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <h3>Hub status</h3>
          <div class="kv">
            <div>channel</div><div><code class="k" id="ch">iruka/game</code></div>
            <div>version</div><div><code class="k" id="ver">1.0.0</code></div>
            <div>sessionId</div>
            <div class="row">
              <code class="k" id="sid"></code>
              <button id="regenSidBtn">New</button>
            </div>
            <div>iframe origin</div><div><code class="k" id="iframeOrigin">-</code></div>
            <div>pending</div><div><code class="k" id="pendingCount">0</code></div>
            <div>last requestId</div><div><code class="k" id="lastReq">-</code></div>
            <div>last status</div><div id="lastStatus" class="muted">-</div>
            <div>hub score</div><div><code class="k" id="hubScore">0</code></div>
            <div>hub time</div><div><code class="k" id="hubTime">00:00.0</code></div>
          </div>

          <div class="row" style="margin-top:8px">
            <label class="muted"><input id="autoInit" type="checkbox" checked /> auto INIT</label>
            <label class="muted"><input id="autoStart" type="checkbox" /> auto START</label>
            <label class="muted"><input id="strictEnv" type="checkbox" checked /> strict envelope</label>
          </div>
        </div>

        <div class="card">
          <h3>Hub ‚Üí Game commands</h3>
          <div class="row">
            <button id="btnInit">INIT</button>
            <button id="btnStart">START</button>
            <button id="btnPause">PAUSE</button>
            <button id="btnResume">RESUME</button>
            <button id="btnQuit">QUIT</button>
            <button id="btnResize">RESIZE now</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnShowLoading">Hub loading ON</button>
            <button id="btnShowRotate">Hub rotate ON</button>
            <button id="btnShowResultWin">Hub result WIN</button>
            <button id="btnShowResultLose">Hub result LOSE</button>
          </div>
          <div class="muted" style="margin-top:8px">
            ‚ÄúAssetManager/AudioManager/Score/Timer‚Äù c·ªßa b·∫°n n·∫±m trong game; hub s·∫Ω k√≠ch b·∫±ng
            <code class="k">SET_STATE</code> (tu·ª≥ b·∫°n map). B√™n d∆∞·ªõi c√≥ preset.
          </div>
        </div>

        <div class="card">
          <h3>SET_STATE (Hub ‚Üí Game)</h3>
          <div class="row" style="margin-bottom:8px">
            <select id="statePreset" style="flex:1">
              <option value="custom">Custom JSON</option>
              <option value="audio_unlock">Preset: audio unlock</option>
              <option value="audio_play_click">Preset: audio play click</option>
              <option value="score_add_10">Preset: score +10</option>
              <option value="timer_start">Preset: timer start</option>
              <option value="timer_reset">Preset: timer reset</option>
              <option value="result_win">Preset: result win</option>
            </select>
            <button id="btnApplyPreset">Apply</button>
            <button id="btnSendSetState">Send SET_STATE</button>
          </div>
          <textarea id="setStateJson"></textarea>
          <div class="muted">
            Preset d√πng namespace <code class="k">__hub</code> ƒë·ªÉ b·∫°n d·ªÖ route trong game:
            v√≠ d·ª• <code class="k">{ "__hub": { "audio": { "cmd":"unlock" } } }</code>
          </div>
        </div>

        <div class="card">
          <h3>Mock SAVE/LOAD (Game ‚Üí Hub)</h3>
          <div class="row">
            <button id="btnWipe">Wipe</button>
            <button id="btnDump">Dump</button>
          </div>
          <div class="muted" style="margin-top:8px">
            - Game g·ª≠i <code class="k">REQUEST_SAVE</code>: Hub l∆∞u localStorage theo sessionId.<br/>
            - Game g·ª≠i <code class="k">REQUEST_LOAD</code>: Hub tr·∫£ v·ªÅ <code class="k">SET_STATE</code> payload <code class="k">__hub.loadResult</code>.
          </div>
          <pre id="storageView" style="min-height:120px"></pre>
        </div>

        <div class="card">
          <h3>Log (newest first)</h3>
          <div class="row" style="margin-bottom:8px">
            <button id="btnClearLog">Clear</button>
            <button id="btnExportLog">Export log.json</button>
          </div>
          <pre id="log"></pre>
        </div>
      </aside>
    </main>

    <script>
        // ===== SDK Protocol constants (theo format m·ªõi) =====
        const SDK_VERSION = "1.0.0";
        const MAX_MESSAGE_BYTES = 16 * 1024;

        // ===== App config =====
        const qs = new URLSearchParams(location.search);
        const DEFAULT_GAME_URL = qs.get("gameUrl") || "http://localhost:5173/";
        const STORAGE_PREFIX = "iruka:save:";

        // ===== Defaults ƒë·ªÉ build LaunchContext (b·∫°n s·ª≠a cho ƒë√∫ng d·ª± √°n) =====
        const HUB_META = {
            playerId: "player-123",
            gameId: "game.id",        // üëà ƒë·ªïi th√†nh id th·∫≠t n·∫øu c√≥
            lessonId: "lessonId",     // üëà ƒë·ªïi n·∫øu c·∫ßn
            gameVersion: "1.0.0",
            locale: "vi-VN",
            difficulty: "normal",
            launchToken: "dev-launch-token",
        };

        const $ = (id) => document.getElementById(id);

        const frame = $("gameFrame");
        const stageWrap = $("stageWrap");
        const logEl = $("log");
        const urlInput = $("url");
        const originModeEl = $("originMode");
        const allowedOriginEl = $("allowedOrigin");
        const strictEnvEl = $("strictEnv");

        const sidEl = $("sid");
        const iframeOriginEl = $("iframeOrigin");
        const pendingCountEl = $("pendingCount");
        const lastReqEl = $("lastReq");
        const lastStatusEl = $("lastStatus");
        const hubScoreEl = $("hubScore");
        const hubTimeEl = $("hubTime");

        const setStateJsonEl = $("setStateJson");
        const storageViewEl = $("storageView");

        const loadingOverlay = $("loadingOverlay");
        const rotateOverlay = $("rotateOverlay");
        const resultOverlay = $("resultOverlay");
        const resultTitle = $("resultTitle");
        const resultBody = $("resultBody");

        // ===== Panel toggle =====
        const togglePanelBtn = $("togglePanelBtn");
        const PANEL_KEY = "iruka:hub:panelCollapsed";

        function setPanelCollapsed(collapsed) {
          document.body.classList.toggle("panel-collapsed", !!collapsed);
          if (togglePanelBtn) {
            togglePanelBtn.textContent = collapsed ? "Panel ‚óÄ" : "Panel ‚ñ∂";
            togglePanelBtn.setAttribute("aria-expanded", String(!collapsed));
          }
          try { localStorage.setItem(PANEL_KEY, collapsed ? "1" : "0"); } catch {}
        }

        // init from storage
        let collapsedInit = false;
        try { collapsedInit = localStorage.getItem(PANEL_KEY) === "1"; } catch {}
        setPanelCollapsed(collapsedInit);

        if (togglePanelBtn) {
          togglePanelBtn.onclick = () => {
            const collapsedNow = document.body.classList.contains("panel-collapsed");
            setPanelCollapsed(!collapsedNow);
            // Khi ƒë·ªïi layout, g·ª≠i RESIZE ƒë·ªÉ game t·ª± reflow n·∫øu c·∫ßn
            try { sendResize(); } catch {}
          };
        }

        // ===== UI: update header badges =====
        $("ch").textContent = "hub";
        $("ver").textContent = SDK_VERSION;

        const eventLog = [];
        const HUB_LOG_MAX = 2000; // ‚úÖ tr√°nh ph√¨nh log khi ch·∫°y l√¢u/loop
        function now() { return new Date().toISOString(); }

        // ‚úÖ sanitize ƒë·ªÉ tr√°nh circular/too large trong artifacts
        function safeCloneSmall(v, maxChars = 4000) {
          try {
            const json = JSON.stringify(v);
            if (json.length <= maxChars) return JSON.parse(json);
            return { truncated: true, preview: json.slice(0, maxChars) + "‚Ä¶" };
          } catch {
            return { unserializable: true, preview: String(v) };
          }
        }

        function log(dir, msg, extra = {}) {
            const rec = {
              t: now(),
              dir,
              type: (msg && typeof msg === "object") ? msg.type : undefined,
              sessionId: (msg && typeof msg === "object") ? msg.sessionId : undefined,
              msg: safeCloneSmall(msg),
              extra: safeCloneSmall(extra),
            };
            eventLog.unshift(rec);
            if (eventLog.length > HUB_LOG_MAX) eventLog.length = HUB_LOG_MAX;

            const txt =
            `[${rec.t}] ${dir}\n` +
            (typeof msg === "string" ? msg : JSON.stringify(msg, null, 2)) +
            (Object.keys(extra).length ? ("\n" + JSON.stringify(extra, null, 2)) : "") +
            "\n\n";
            logEl.textContent = txt + logEl.textContent;
            console.log("[HUB]", dir, msg, extra);
        }
        function exportLog() {
            const blob = new Blob([JSON.stringify(eventLog, null, 2)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "iruka-gamehub-log.json";
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function nanoid(len = 16) {
            const s = "abcdefghijklmnopqrstuvwxyz0123456789";
            let out = "";
            for (let i = 0; i < len; i++) out += s[(Math.random() * s.length) | 0];
            return out;
        }

        //
        function isIrukaMsg(m) {
            return m && typeof m === "object" && m.sdkVersion && m.source && m.sessionId && m.type;
        }

        // ‚úÖ incoming origin allowlist (khi lock)
        function isIncomingOriginAllowed(origin) {
          if (originModeEl.value === "any") return true;
          const allowed = (allowedOriginEl.value || "").trim();
          return !!allowed && origin === allowed;
        }

        // ‚úÖ expose cho Playwright/runner
        window.__hubTest = {
            setGameUrl(url) { urlInput.value = url; loadIframe(url); },
            setOriginAny() { originModeEl.value = "any"; },
            setOriginLock(origin) { originModeEl.value = "lock"; allowedOriginEl.value = origin; },
            setAllowedOrigin(origin) { allowedOriginEl.value = origin; },
            setMeta(patch) { try { Object.assign(HUB_META, patch || {}); } catch {} },
            setSessionId(sid) { sessionId = String(sid || ""); renderSid(); refreshStorageView(); },
            sendInit,
            sendCmd,
            sendSetState,
            clearLogs() { eventLog.length = 0; logEl.textContent = ""; },
            getLogs() { return eventLog.slice(); },
            dumpArtifacts() {
              return {
                meta: {
                  sdkVersion: SDK_VERSION,
                  sessionId,
                  hubMeta: { ...HUB_META },
                  originMode: originModeEl.value,
                  allowedOrigin: allowedOriginEl.value || "",
                  gameUrl: urlInput.value || "",
                },
                logs: eventLog.slice(),
              };
            }
        };


        // ===== Hub sessionId =====
        let sessionId = nanoid(18);
        function renderSid() { sidEl.textContent = sessionId; }
        renderSid();
        $("regenSidBtn").onclick = () => { sessionId = nanoid(18); renderSid(); refreshStorageView(); };

        // ===== Envelope helpers (format m·ªõi) =====
        function estimateJsonBytes(v) { try { return JSON.stringify(v).length; } catch { return Infinity; } }

        // MsgEnvelope ƒë√∫ng theo b·∫°n y√™u c·∫ßu
        function makeEnvelope({ type, payload }) {
            const env = {
            sdkVersion: SDK_VERSION,
            source: "hub",
            sessionId: (payload && typeof payload === "object" && payload.sessionId) ? payload.sessionId : sessionId,
            gameId: (payload && typeof payload === "object" && payload.gameId) ? payload.gameId : HUB_META.gameId,
            lessonId: (payload && typeof payload === "object" && payload.lessonId) ? payload.lessonId : HUB_META.lessonId,
            gameVersion: (payload && typeof payload === "object" && payload.gameVersion) ? payload.gameVersion : HUB_META.gameVersion,
            type,
            payload
            };

            const bytes = estimateJsonBytes(env);
            if (bytes > MAX_MESSAGE_BYTES) {
            log("HUB", "‚ùå payload_too_large", { bytes, limit: MAX_MESSAGE_BYTES, type });
            return null;
            }
            return env;
        }

        // Strict mode: validate theo format m·ªõi
        function isValidEnvelope(v) {
            if (!v || typeof v !== "object") return false;
            if (typeof v.sdkVersion !== "string" || !v.sdkVersion) return false;
            if (typeof v.source !== "string" || !v.source) return false;
            if (typeof v.sessionId !== "string" || !v.sessionId) return false;
            if (typeof v.type !== "string" || !v.type) return false;
            // gameId/lessonId/gameVersion/payload c√≥ th·ªÉ t√πy game g·ª≠i l√™n
            return true;
        }

        function getPostOrigin() {
            if (originModeEl.value === "any") return "*";
            return (allowedOriginEl.value || "").trim() || "*";
        }
        function postToGame(env, traceId) {
            if (!frame.contentWindow) return;
            const origin = getPostOrigin();
            frame.contentWindow.postMessage(env, origin);
            log("HUB ‚Üí GAME", env, { postOrigin: origin, traceId });
        }

        // ===== Pending tracking (traceId n·ªôi b·ªô) =====
        const pending = new Map(); // traceId -> { t0, type }
        function setPendingUI() { pendingCountEl.textContent = String(pending.size); }
        function markReq(traceId, type) {
            pending.set(traceId, { t0: performance.now(), type });
            setPendingUI();
            lastReqEl.textContent = traceId;
            lastStatusEl.className = "muted";
            lastStatusEl.textContent = `pending (${type})`;
        }
        function markRes(traceId, ok, type) {
            const p = pending.get(traceId);
            if (p) pending.delete(traceId);
            setPendingUI();
            const dt = p ? Math.round(performance.now() - p.t0) : null;
            lastReqEl.textContent = traceId;
            lastStatusEl.className = ok ? "ok" : "bad";
            lastStatusEl.textContent = ok
            ? `ok (${type})${dt !== null ? ` in ${dt}ms` : ""}`
            : `fail (${type})${dt !== null ? ` in ${dt}ms` : ""}`;
        }
        // Kh√¥ng c√≥ requestId t·ª´ game => ch·ªâ ‚Äúbest-effort‚Äù: nh·∫≠n msg n√†o th√¨ clear pending ƒë·∫ßu ti√™n
        function ackAnyIncoming(inType) {
            const it = pending.entries().next();
            if (!it.done) {
            const [traceId, info] = it.value;
            markRes(traceId, true, `${info.type} ‚Üê ${inType}`);
            }
        }

        // ===== Hub score/time (m√¥ ph·ªèng) =====
        let hubScore = 0;
        let hubStartAt = performance.now();
        function fmtTime(ms) {
            ms = Math.max(0, ms | 0);
            const s = ms / 1000;
            const mm = String(Math.floor(s / 60)).padStart(2, "0");
            const ss = String(Math.floor(s % 60)).padStart(2, "0");
            const t = String(Math.floor((ms % 1000) / 100));
            return `${mm}:${ss}.${t}`;
        }
        function renderHubHUD() {
            hubScoreEl.textContent = String(hubScore);
            hubTimeEl.textContent = fmtTime(performance.now() - hubStartAt);
        }
        setInterval(renderHubHUD, 200);
        
        // ===== Result summary derivation & rendering =====
        function pickNumber(v, fallback = 0) {
          return (typeof v === "number" && !Number.isNaN(v)) ? v : fallback;
        }
        function last(arr) {
          return Array.isArray(arr) && arr.length ? arr[arr.length - 1] : null;
        }
        function computeTimeSpentMs(payload) {
          // ∆∞u ti√™n timeMs ·ªü root
          if (typeof payload?.timeMs === "number") return payload.timeMs;

          // fallback: attempt g·∫ßn nh·∫•t ended-start
          const hist = payload?.extras?.stats?.completion_history;
          const a = last(hist);
          if (a && typeof a.startedAtMs === "number" && typeof a.endedAtMs === "number") {
            return Math.max(0, a.endedAtMs - a.startedAtMs);
          }
          return 0;
        }
        function deriveResultFields(payload) {
          const stats = payload?.extras?.stats || {};
          const hist = Array.isArray(stats.completion_history) ? stats.completion_history : [];

          const attemptsTotal =
            (typeof stats.attemptsTotal === "number" ? stats.attemptsTotal : 0) ||
            hist.length ||
            0;

          const mistakesTotal =
            (typeof stats.mistakeCount === "number" ? stats.mistakeCount : null) ??
            hist.reduce((sum, a) => sum + (typeof a.wrong === "number" ? a.wrong : 0), 0);

          const retriesTotal =
            (typeof stats.retryCount === "number" ? stats.retryCount : null) ??
            Math.max(0, attemptsTotal - 1);

          const hintsUsedTotal = pickNumber(stats.hintCount, 0);

          const coreScoreFinal =
            (typeof stats.finalScore === "number" ? stats.finalScore : null) ??
            pickNumber(payload?.score, 0);

          const bestScore =
            (typeof stats.bestScore === "number" ? stats.bestScore : null) ??
            coreScoreFinal;

          const accuracyFinal = (typeof stats.accuracy === "number") ? stats.accuracy : null;

          const timeSpentMs = computeTimeSpentMs(payload);

          return {
            timeSpentMs,
            hintsUsedTotal,
            retriesTotal,
            attemptsTotal,
            coreScoreFinal,
            bestScore,
            mistakesTotal,
            accuracyFinal,
          };
        }
        function formatMs(ms) {
          ms = Math.max(0, ms | 0);
          const s = ms / 1000;
          const mm = String(Math.floor(s / 60)).padStart(2, "0");
          const ss = String(Math.floor(s % 60)).padStart(2, "0");
          const t = String(Math.floor((ms % 1000) / 100));
          return `${mm}:${ss}.${t}`;
        }
        function formatPercent(x) {
          if (typeof x !== "number") return "-";
          return `${(x * 100).toFixed(2)}%`;
        }

        function renderResultSummary(payload) {
          const f = deriveResultFields(payload || {});

          // clear
          resultBody.textContent = "";

          // grid summary
          const grid = document.createElement("div");
          grid.className = "resultGrid";

          const rows = [
            ["timeSpentMs  (Th·ªùi gian ch∆°i) ", `${formatMs(f.timeSpentMs)} (${f.timeSpentMs}ms)`],
            ["hintsUsedTotal (T·ªïng s·ªë g·ª£i √Ω ƒë√£ s·ª≠ d·ª•ng)", String(f.hintsUsedTotal)],
            ["retriesTotal (T·ªïng s·ªë l·∫ßn ch∆°i l·∫°i)", String(f.retriesTotal)],
            ["attemptsTotal (T·ªïng s·ªë l·∫ßn th·ª≠)", String(f.attemptsTotal)],
            ["coreScoreFinal (ƒêi·ªÉm cu·ªëi c√πng)", String(f.coreScoreFinal)],
            ["bestScore (ƒêi·ªÉm cao nh·∫•t)", String(f.bestScore)],
            ["mistakesTotal (T·ªïng s·ªë l·ªói trong l∆∞·ª£t ch∆°i)", String(f.mistakesTotal)],
            ["accuracyFinal (T·ªâ l·ªá ch√≠nh x√°c cu·ªëi c√πng)", formatPercent(f.accuracyFinal)],
          ];

          for (const [k, v] of rows) {
            const kEl = document.createElement("div");
            kEl.className = "k";
            kEl.textContent = k;

            const vEl = document.createElement("div");
            vEl.className = "v";
            vEl.textContent = v;

            grid.appendChild(kEl);
            grid.appendChild(vEl);
          }

          resultBody.appendChild(grid);

          // dropdown JSON g·ªëc (native)
          const details = document.createElement("details");
          details.className = "rawJson";

          const summary = document.createElement("summary");
          summary.textContent = "Xem JSON g·ªëc";

          const pre = document.createElement("pre");
          pre.textContent = JSON.stringify(payload, null, 2);

          details.appendChild(summary);
          details.appendChild(pre);
          resultBody.appendChild(details);
        }

        // ===== Overlays =====
        function setOverlay(el, on) { el.classList.toggle("show", !!on); }
        $("loadingOffBtn").onclick = () => setOverlay(loadingOverlay, false);
        $("rotateOffBtn").onclick = () => setOverlay(rotateOverlay, false);
        $("resultCloseBtn").onclick = () => setOverlay(resultOverlay, false);
        $("resultReplayBtn").onclick = () => {
            sendSetState({ __hub: { nav: "replay" } });
            setOverlay(resultOverlay, false);
        };
        $("resultNextBtn").onclick = () => {
            sendSetState({ __hub: { nav: "next" } });
            setOverlay(resultOverlay, false);
        };
        function showResult(kind, payload) {
          resultTitle.textContent = kind === "WIN" ? "Th·∫Øng ‚úÖ" : "Thua ‚ùå";
          renderResultSummary(payload || {});
          setOverlay(resultOverlay, true);
        }

        // ===== LaunchContext builder (INIT.payload = context) =====
        function buildLaunchContext() {
            return {
            sdkVersion: SDK_VERSION,
            playerId: HUB_META.playerId || "player-123",
            sessionId: sessionId,
            lessonId: HUB_META.lessonId,
            gameVersion: HUB_META.gameVersion,
            gameId: HUB_META.gameId,
            locale: HUB_META.locale, // 'vi-VN'
            difficulty: HUB_META.difficulty,
            seed: Math.floor(Math.random() * 1000000),
            launchToken: HUB_META.launchToken,
            sizeHint: {
                width: window.innerWidth,
                height: window.innerHeight,
                devicePixelRatio: window.devicePixelRatio || 1,
            },
            };
        }

        // ===== Hub commands =====
        function sendInit() {
            // payload INIT = context (ƒë√∫ng y√™u c·∫ßu)
            const context = buildLaunchContext();
            const env = makeEnvelope({ type: "INIT", payload: context });
            if (!env) return;
            const traceId = nanoid(10);
            markReq(traceId, "INIT");
            postToGame(env, traceId);
        }
        function sendCmd(type) {
            const env = makeEnvelope({ type, payload: null });
            if (!env) return;
            const traceId = nanoid(10);
            markReq(traceId, type);
            postToGame(env, traceId);
        }
        function sendResize() {
            const env = makeEnvelope({
            type: "RESIZE",
            payload: {
                width: window.innerWidth,
                height: window.innerHeight,
                devicePixelRatio: window.devicePixelRatio || 1,
            },
            });
            if (!env) return;
            const traceId = nanoid(10);
            markReq(traceId, "RESIZE");
            postToGame(env, traceId);
        }
        function sendSetState(stateObj) {
            const env = makeEnvelope({ type: "SET_STATE", payload: stateObj });
            if (!env) return;
            const traceId = nanoid(10);
            markReq(traceId, "SET_STATE");
            postToGame(env, traceId);
        }

        // ===== Mock SAVE/LOAD storage =====
        function storageKey() { return `${STORAGE_PREFIX}${sessionId}`; }
        function safeParse(s) { try { return JSON.parse(s); } catch { return null; } }
        function refreshStorageView() {
            const raw = localStorage.getItem(storageKey());
            storageViewEl.textContent = JSON.stringify({ key: storageKey(), value: safeParse(raw) }, null, 2);
        }
        function wipeStorage() {
            localStorage.removeItem(storageKey());
            refreshStorageView();
            log("HUB", "Wiped storage", { key: storageKey() });
        }
        refreshStorageView();

        // ===== Receive from game =====
        window.addEventListener("message", (ev) => {
            // console.log("RAW FROM GAME:", ev.origin, ev.data); 
            const msg = ev.data;

            // ‚úÖ 0) ch·ªâ nh·∫≠n t·ª´ ƒë√∫ng iframe game
            if (ev.source !== frame.contentWindow) return;

            // ‚úÖ 1) l·ªçc message r√°c: must match schema + must be from "game"
            if (!isIrukaMsg(msg)) return;
            if (msg.source !== "game") return;

            // ‚úÖ 2) origin allowlist khi lock
            if (!isIncomingOriginAllowed(ev.origin)) return;

            if (strictEnvEl.checked) {
            if (!isValidEnvelope(msg)) return;
            } else {
            if (!msg || typeof msg !== "object" || !msg.type) return;
            }

            iframeOriginEl.textContent = ev.origin || "-";
            log("GAME ‚Üí HUB", msg, { origin: ev.origin });

            // best-effort ack UI
            ackAnyIncoming(msg.type);

            switch (msg.type) {
            case "READY": {
                if ($("autoStart").checked) sendCmd("START");
                return;
            }
            case "LOADING": {
                const p = msg.payload?.progress;
                if (typeof p === "number") {
                if (p < 1) setOverlay(loadingOverlay, true);
                else setOverlay(loadingOverlay, false);
                }
                return;
            }
            case "SCORE_UPDATE": {
                const s = msg.payload?.score;
                if (typeof s === "number") hubScore = s;
                renderHubHUD();
                return;
            }
            case "COMPLETE": {
                showResult("WIN", msg.payload || {});
                return;
            }
            case "ERROR": {
                showResult("LOSE", msg.payload || {});
                return;
            }
            case "REQUEST_SAVE": {
                localStorage.setItem(storageKey(), JSON.stringify(msg.payload ?? null));
                refreshStorageView();
                sendSetState({ __hub: { saveResult: { ok: true } } });
                return;
            }
            case "REQUEST_LOAD": {
                const raw = localStorage.getItem(storageKey());
                const data = safeParse(raw);
                sendSetState({ __hub: { loadResult: { ok: true, data } } });
                return;
            }
            default:
                return;
            }
        });

        // ===== Resize observer ‚Üí auto send RESIZE =====
        const ro = new ResizeObserver(() => sendResize());
        ro.observe(stageWrap);
        window.addEventListener("resize", () => sendResize());

        // ===== UI wiring =====
        urlInput.value = DEFAULT_GAME_URL;
        allowedOriginEl.value = new URL(DEFAULT_GAME_URL).origin;

        function loadIframe(url) {
            frame.src = url;
            log("HUB", `Load iframe: ${url}`);
            frame.onload = () => {
            try { allowedOriginEl.value = new URL(url).origin; } catch {}
            if ($("autoInit").checked) sendInit();
            };
        }

        $("loadBtn").onclick = () => loadIframe(urlInput.value.trim());
        $("reloadBtn").onclick = () => {
            if (!frame.src) loadIframe(urlInput.value.trim());
            else {
            try { frame.contentWindow?.location?.reload(); }
            catch { frame.src = frame.src; }
            }
            log("HUB", "Reload iframe");
        };

        $("btnInit").onclick = sendInit;
        $("btnStart").onclick = () => sendCmd("START");
        $("btnPause").onclick = () => sendCmd("PAUSE");
        $("btnResume").onclick = () => sendCmd("RESUME");
        $("btnQuit").onclick = () => sendCmd("QUIT");
        $("btnResize").onclick = sendResize;

        $("btnShowLoading").onclick = () => setOverlay(loadingOverlay, true);
        $("btnShowRotate").onclick = () => setOverlay(rotateOverlay, true);
        $("btnShowResultWin").onclick = () =>
            showResult("WIN", { score: hubScore, timeMs: Math.round(performance.now() - hubStartAt) });
        $("btnShowResultLose").onclick = () => showResult("LOSE", { reason: "manual" });

        $("btnWipe").onclick = wipeStorage;
        $("btnDump").onclick = () => {
            refreshStorageView();
            log("HUB", "Storage dump", { storage: safeParse(localStorage.getItem(storageKey())) });
        };

        $("btnClearLog").onclick = () => (logEl.textContent = "");
        $("btnExportLog").onclick = exportLog;

        // presets for SET_STATE
        const presets = {
            audio_unlock: { __hub: { audio: { cmd: "unlock" } } },
            audio_play_click: { __hub: { audio: { cmd: "play", key: "click" } } },
            score_add_10: { __hub: { score: { cmd: "add", delta: 10 } } },
            timer_start: { __hub: { timer: { cmd: "start" } } },
            timer_reset: { __hub: { timer: { cmd: "reset" } } },
            result_win: { __hub: { result: { cmd: "show", kind: "win" } } },
        };

        function applyPreset() {
            const k = $("statePreset").value;
            if (k === "custom") return;
            setStateJsonEl.value = JSON.stringify(presets[k], null, 2);
        }
        $("btnApplyPreset").onclick = applyPreset;
        $("btnSendSetState").onclick = () => {
            const obj = safeParse(setStateJsonEl.value);
            if (!obj) { log("HUB", "‚ùå JSON invalid in SET_STATE"); return; }
            sendSetState(obj);
        };

        setStateJsonEl.value = JSON.stringify(presets.audio_unlock, null, 2);

        // auto load
        loadIframe(DEFAULT_GAME_URL);
    </script>
  </body>
</html>