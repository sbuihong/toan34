import{P as g}from"./phaser_vendor-D9yEWc94.js";import{h as E,g as u,_ as lt}from"./vendor-CiDEJBbE.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();var H=(s=>(s.Preload="PreloadScene",s.Scene1="Scene1",s.Scene2="Scene2",s.Scene3="Scene3",s.EndGame="EndGameScene",s.UI="UIScene",s))(H||{}),f=(s=>(s.BtnExit="btn_exit",s.BtnReset="btn_reset",s.BtnEraser="btn_eraser",s.HandHint="hand_hint",s.Decor="decor",s.So1="so1",s.Dice="dice",s.S1_Banner="banner_s2",s.S1_BannerText="text_banner_s2",s.S1_Board="board_s2",s.S1_Casau_Template="ca_sau_template",s.S1_Frame="frame",s.S1_Name="name",s.S1_Name_Bg="name_bg",s.S1_Outline="outline",s.S1_1="1",s.S1_Q1="q1",s.S1_Q2="q2",s.S1_Q3="q3",s.S1_Q4="q4",s.S2_Q1="s2_q1",s.S2_Q2="s2_q2",s.S3_Q1="s3_q1",s.S3_Q2="s3_q2",s.BtnS1_1="s1_btn_1",s.BtnS1_2="s1_btn_2",s.BtnS1_3="s1_btn_3",s.BtnS1_4="s1_btn_4",s.BtnS1_5="s1_btn_5",s.BtnS1_6="s1_btn_6",s.BtnS1_7="s1_btn_7",s.End_Icon="icon_end",s.End_BannerCongrat="banner_congrat",s))(f||{}),N=(s=>(s.BgmNen="bgm-nen",s))(N||{}),Z=(s=>(s.LevelS1Config="level_1_config",s.LevelS2Config="level_2_config",s.LevelS3Config="level_3_config",s))(Z||{});const A={PALETTE_DATA:[{key:f.BtnS1_1,color:1769216}],IDLE:{THRESHOLD:1e4,FADE_IN:800,SCALE:300,FADE_OUT:500},SCENE1:{UI:{BANNER_Y:.001,BOARD_OFFSET:.03},TIMING:{INTRO_DELAY:1e3,RESTART_INTRO:200,WIN_DELAY:2500,AUTO_FILL:100}},PAINT:{BRUSH_SIZE:100,WIN_PERCENT:.9,DEFAULT_COLOR:6202453}};class B{static getW(t){return t.scale.width}static getH(t){return t.scale.height}static pctX(t,e){return t.scale.width*e}static pctY(t,e){return t.scale.height*e}static centerObj(t,e){e.setPosition(t.scale.width/2,t.scale.height/2)}static calculateCenteredOffset(t,e){const n=t.textures.get(e).getSourceImage();if(n instanceof HTMLImageElement||n instanceof HTMLCanvasElement){const a=n.width,o=n.height,r=document.createElement("canvas");r.width=a,r.height=o;const d=r.getContext("2d");if(!d)return{x:0,y:0};d.drawImage(n,0,0);const c=d.getImageData(0,0,a,o).data;let l=0,S=0,h=0;const _=[],v=4;for(let I=0;I<o;I+=v)for(let b=0;b<a;b+=v){const L=(I*a+b)*4;c[L+3]>50&&(l+=b,S+=I,h++,_.push({x:b,y:I}))}if(h===0||_.length===0)return{x:0,y:0};let P=Math.floor(l/h),k=Math.floor(S/h);const U=(k*a+P)*4,F=c[U+3],W=(I,b)=>{const M=[{dx:0,dy:-2},{dx:0,dy:2},{dx:-2,dy:0},{dx:2,dy:0},{dx:-2,dy:-2},{dx:2,dy:-2},{dx:-2,dy:2},{dx:2,dy:2}];for(const R of M){const Y=I+R.dx,q=b+R.dy;if(Y<0||Y>=a||q<0||q>=o)return!1;const ct=(q*a+Y)*4;if(c[ct+3]<=50)return!1}return!0};if(!F||F<=50){let I=1/0,b=_[0],L=!1;for(const M of _){const R=(M.x-P)**2+(M.y-k)**2;W(M.x,M.y)?L?R<I&&(I=R,b=M):(L=!0,I=R,b=M):L||R<I&&(I=R,b=M)}P=b.x,k=b.y}const rt=P-a/2,ot=k-o/2;return{x:rt,y:ot}}return{x:0,y:0}}}class ht{constructor(t,e){this.timer=0,this.isActive=!1,this.threshold=t,this.callback=e}start(){this.isActive=!0,this.timer=0}stop(){this.isActive=!1,this.timer=0}reset(){this.isActive&&(this.timer=0)}update(t){this.isActive&&(this.timer+=t,this.timer>this.threshold&&(this.callback(),this.timer=0))}}let G=!0;function dt(s){const t=document.getElementById("bg-layer-a"),e=document.getElementById("bg-layer-b");if(!t||!e)return;const i=G?t:e,n=G?e:t,a=`url('${s}')`;i.style.backgroundImage!==a&&(n.style.backgroundImage=a,n.classList.add("visible"),i.classList.remove("visible"),G=!G)}class ut{constructor(t,e){this.brushColor=A.PAINT.DEFAULT_COLOR,this.brushSize=A.PAINT.BRUSH_SIZE,this.brushTexture="brush_circle",this.isErasing=!1,this.activeRenderTexture=null,this.activeHitArea=null,this.lastX=0,this.lastY=0,this.ignoreCameraId=0,this.partColors=new Map,this.partUncheckedMetrics=new Map,this.maskCache=new Map,this.CHECK_THRESHOLD=300,this.scene=t,this.onPartComplete=e,this.scene.input.topOnly=!1,this.helperCanvasPaint=document.createElement("canvas"),this.helperCanvasMask=document.createElement("canvas"),this.createBrushTexture()}createBrushTexture(){if(!this.scene.textures.exists(this.brushTexture)){const t=this.scene.textures.createCanvas(this.brushTexture,this.brushSize,this.brushSize);if(t){const e=t.context,i=e.createRadialGradient(this.brushSize/2,this.brushSize/2,0,this.brushSize/2,this.brushSize/2,this.brushSize/2);i.addColorStop(0,"rgba(255, 255, 255, 1)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=i,e.fillRect(0,0,this.brushSize,this.brushSize),t.refresh()}}}setColor(t){this.isErasing=!1,this.brushColor=t}setEraser(){this.isErasing=!0}setIgnoreCameraId(t){this.ignoreCameraId=t}isPainting(){return this.activeRenderTexture!==null}createPaintableLayer(t,e,i,n,a){const o=this.scene.make.image({x:t,y:e,key:i,add:!1}).setScale(n),r=o.createBitmapMask(),d=o.width*n,p=o.height*n,c=this.scene.add.renderTexture(t-d/2,e-p/2,d,p);c.clear().setAlpha(0),c.setOrigin(0,0).setDepth(10),c.setData("id",a),c.setData("key",i),c.setData("isFinished",!1),c.setData("mask",r),this.ignoreCameraId&&(c.cameraFilter=this.ignoreCameraId);const l=this.scene.add.image(t,e,i).setScale(n).setAlpha(.01).setDepth(50);return l.setInteractive({useHandCursor:!0,pixelPerfect:!0}),this.ignoreCameraId&&(l.cameraFilter=this.ignoreCameraId),l.setData("layer",c),l.setData("id",a),l.on("pointerdown",S=>{this.activeHitArea!==l&&(this.activeHitArea&&this.freezePart(this.activeHitArea),this.unfreezePart(l),this.activeHitArea=l);const h=l.getData("layer");if(h instanceof g.GameObjects.RenderTexture){if(!h.mask){const _=h.getData("mask");_&&h.setMask(_)}this.activeRenderTexture=h,this.lastX=S.x-h.x,this.lastY=S.y-h.y,this.paint(S,h)}}),l}handlePointerMove(t){t.isDown&&this.activeRenderTexture&&this.paint(t,this.activeRenderTexture)}handlePointerUp(){if(this.isErasing){this.activeRenderTexture=null;return}if(this.activeRenderTexture){const t=this.activeRenderTexture.getData("id");(this.partUncheckedMetrics.get(t)||0)>this.CHECK_THRESHOLD&&(this.checkProgress(this.activeRenderTexture),this.partUncheckedMetrics.set(t,0)),this.activeRenderTexture=null}}freezePart(t){const e=t.getData("layer");if(e instanceof g.GameObjects.RenderTexture){const i=t.getData("id"),n=`painted_tex_${i}`;this.scene.textures.exists(n)&&this.scene.textures.remove(n),e.saveTexture(n);const a=this.scene.add.image(e.x,e.y,n);a.setOrigin(0,0).setDepth(10);const o=e.getData("mask");o&&a.setMask(o),this.ignoreCameraId&&(a.cameraFilter=this.ignoreCameraId),a.setData("id",i),a.setData("key",e.getData("key")),a.setData("isFinished",e.getData("isFinished")),a.setData("mask",o),t.setData("layer",a),e.destroy()}}unfreezePart(t){const e=t.getData("layer");if(e instanceof g.GameObjects.Image){const i=e.width,n=e.height,a=e.x,o=e.y,r=this.scene.add.renderTexture(a,o,i,n);r.setOrigin(0,0).setDepth(10),e.clearMask(),r.draw(e,0,0);const d=e.getData("mask");d&&r.setMask(d),this.ignoreCameraId&&(r.cameraFilter=this.ignoreCameraId),r.setData("id",e.getData("id")),r.setData("key",e.getData("key")),r.setData("isFinished",e.getData("isFinished")),r.setData("mask",d),t.setData("layer",r),e.destroy()}}paint(t,e){const i=t.x-e.x,n=t.y-e.y,a=g.Math.Distance.Between(this.lastX,this.lastY,i,n);if(a<10)return;const o=e.getData("id"),r=this.partUncheckedMetrics.get(o)||0;this.partUncheckedMetrics.set(o,r+a);const d=this.brushSize*.65;let p=Math.ceil(a/d);p>50&&(p=50);const c=this.brushSize/2;for(let l=0;l<p;l++){const S=l/p,h=this.lastX+(i-this.lastX)*S,_=this.lastY+(n-this.lastY)*S;this.isErasing?e.erase(this.brushTexture,h-c,_-c):e.draw(this.brushTexture,h-c,_-c,1,this.brushColor)}this.isErasing?e.erase(this.brushTexture,i-c,n-c):(e.draw(this.brushTexture,i-c,n-c,1,this.brushColor),this.partColors.has(o)||this.partColors.set(o,new Set),this.partColors.get(o)?.add(this.brushColor)),this.lastX=i,this.lastY=n}checkProgress(t){if(t.getData("isFinished"))return;const e=t.getData("id"),i=t.getData("key");t.snapshot(n=>{if(!(n instanceof HTMLImageElement))return;const a=n.width,o=n.height,r=Math.floor(a/4),d=Math.floor(o/4),p=this.getRecycledContext(this.helperCanvasPaint,n,r,d);if(!p)return;const c=p.getImageData(0,0,r,d).data;let l=this.maskCache.get(e);if(!l){const v=this.scene.textures.get(i).getSourceImage(),P=this.getRecycledContext(this.helperCanvasMask,v,r,d);if(!P)return;l=P.getImageData(0,0,r,d).data,this.maskCache.set(e,l)}let S=0,h=0;for(let v=3;v<c.length;v+=4)l[v]>0&&(h++,c[v]>0&&S++);if((h>0?S/h:0)>A.PAINT.WIN_PERCENT){t.setData("isFinished",!0);const v=this.partColors.get(e)||new Set([this.brushColor]);this.onPartComplete(e,t,v),this.partColors.delete(e),this.partUncheckedMetrics.delete(e)}})}getRecycledContext(t,e,i,n){t.width=i,t.height=n;const a=t.getContext("2d");return a&&(a.clearRect(0,0,i,n),a.drawImage(e,0,0,i,n)),a}}const C="assets/audio/",X={"sfx-correct":{src:`${C}sfx/correct_answer.mp3`,volume:1},"sfx-correct_s2":{src:`${C}sfx/correct_color.mp3`,volume:1},"sfx-wrong":{src:`${C}sfx/wrong.mp3`,volume:.5},"sfx-click":{src:`${C}sfx/click.mp3`,volume:.5},"sfx-ting":{src:`${C}sfx/correct.mp3`,volume:.6},"voice-rotate":{src:`${C}prompt/rotate.mp3`,volume:.8},voice_intro_s2:{src:`${C}prompt/instruction.mp3`,volume:1},hint:{src:`${C}prompt/hint.mp3`,volume:1},complete:{src:`${C}sfx/complete.mp3`,volume:1},fireworks:{src:`${C}sfx/fireworks.mp3`,volume:1},applause:{src:`${C}sfx/applause.mp3`,volume:1}};class gt{constructor(){this.sounds={},this.isLoaded=!1,E.Howler.autoUnlock=!0,E.Howler.volume(1)}loadAll(){return this.isLoaded?Promise.resolve():new Promise(t=>{const e=Object.keys(X);let i=0;const n=e.length;if(n===0)return t();e.forEach(a=>{const o=X[a];this.sounds[a]=new E.Howl({src:[o.src],loop:o.loop||!1,volume:o.volume||1,html5:!0,onload:()=>{i++,i===n&&(this.isLoaded=!0,t())},onloaderror:(r,d)=>{const p=d instanceof Error?d.message:String(d);console.error(`[Howler Load Error] Key: ${a}, ID: ${r}, Msg: ${p}. Check file path: ${o.src}`),i++,i===n&&(this.isLoaded=!0,t())}})})})}play(t){if(!this.sounds[t]){const e=X[t];if(!e){console.warn(`[AudioManager] Sound ID not found in config: ${t}`);return}this.sounds[t]=new E.Howl({src:[e.src],loop:e.loop||!1,volume:e.volume||1,html5:!0,onloaderror:(i,n)=>{console.error(`[Howler Error] Load failed for ${t}:`,n)}})}return this.sounds[t].play()}stop(t){this.sounds[t]&&this.sounds[t].stop()}stopSound(t){this.sounds[t]&&this.sounds[t].stop()}stopAll(){E.Howler.stop()}stopAllVoicePrompts(){Object.keys(X).filter(e=>e.startsWith("prompt_")||e.startsWith("correct_answer_")).forEach(e=>{this.stopSound(e)})}get isUnlocked(){return E.Howler.ctx&&E.Howler.ctx.state==="running"}unlockAudio(){if(!E.Howler.usingWebAudio)return;const t=new E.Howl({src:["data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAAAAAA=="],volume:0,html5:!0});t.once("play",()=>{t.stop(),console.log("[Howler] Audio context unlocked manually.")}),E.Howler.ctx&&E.Howler.ctx.state!=="running"&&t.play()}getDuration(t){const e=this.sounds[t];return e?e.duration():(console.warn(`[AudioManager] Kh√¥ng t√¨m th·∫•y duration cho key: "${t}"`),0)}}const m=new gt;let y=null,z=!1,w=null,D=null,K=!1,Q=0;const pt=1500;let O=null;const et={breakpoint:768,message:"B√© H√£y Xoay Ngang M√†n H√¨nh ƒê·ªÉ Ch∆°i Nh√© üåà"};function tt(s){return s.startsWith("drag_")||s.startsWith("q_")?1:s==="voice_need_finish"?2:s==="sfx_correct"||s==="sfx_wrong"?3:s==="voice_complete"||s==="voice_intro"||s==="voice_end"||s==="voice-rotate"?4:1}function $(s,t){if(z&&t!=="voice-rotate"){console.warn(`[Rotate] ƒêang overlay xoay m√†n h√¨nh, ch·ªâ ph√°t voice-rotate (b·ªè qua "${t}")`);return}if(t==="voice-rotate"){const a=Date.now();if(a-Q<pt)return;(w==="instruction"||w==="cau_do"||w==="voice_intro_s2")&&(O=w),Q=a,Q=a;try{const r=m;typeof r.stopAll=="function"&&r.stopAll(),typeof r.stopAllVoicePrompts=="function"&&r.stopAllVoicePrompts()}catch(r){console.warn("[Rotate] stop all audio error:",r)}if(w=null,m.play("voice-rotate")===void 0){console.warn('[Rotate] Kh√¥ng ph√°t ƒë∆∞·ª£c audio key="voice-rotate" (Howler).');return}w="voice-rotate";return}const e=tt(t),i=w?tt(w):0;if(w===t||w&&i>e)return;if(w&&(m.stop(w),w=null),(t==="instruction"||t==="cau_do"||t==="voice_intro_s2")&&(O=null),m.play(t)===void 0){console.warn(`[Rotate] Kh√¥ng ph√°t ƒë∆∞·ª£c audio key="${t}" (Howler).`);return}w=t}function ft(){if(K)return;K=!0;const s=e=>{if(z){e.stopPropagation(),typeof e.stopImmediatePropagation=="function"&&e.stopImmediatePropagation(),e.preventDefault();try{$(null,"voice-rotate")}catch(i){console.warn("[Rotate] global pointer play voice-rotate error:",i)}}};["pointerdown","pointerup","click","touchstart","touchend","mousedown","mouseup"].forEach(e=>{window.addEventListener(e,s,{capture:!0,passive:!1})})}function st(){if(y)return;y=document.createElement("div"),y.id="rotate-overlay",y.style.position="fixed",y.style.inset="0",y.style.zIndex="2147483647",y.style.display="none",y.style.alignItems="center",y.style.justifyContent="center",y.style.textAlign="center",y.style.background="rgba(0, 0, 0, 0.6)",y.style.padding="16px",y.style.boxSizing="border-box",y.style.pointerEvents="auto";const s=document.createElement("div");s.style.background="white",s.style.borderRadius="16px",s.style.padding="16px 20px",s.style.maxWidth="320px",s.style.margin="0 auto",s.style.fontFamily='"Fredoka", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',s.style.boxShadow="0 8px 24px rgba(0,0,0,0.25)";const t=document.createElement("div");t.textContent=et.message,t.style.fontSize="18px",t.style.fontWeight="700",t.style.marginBottom="8px",t.style.color="#222",s.appendChild(t),y.appendChild(s),document.body.appendChild(y)}function j(){if(st(),!y)return;const s=window.innerWidth,e=window.innerHeight>s&&s<et.breakpoint,i=z;z=e;const n=!i&&e,a=i&&!e;if(y.style.display=e?"flex":"none",n)try{$(null,"voice-rotate"),D&&D.scene&&D.scene.isActive()&&D.scene.pause()}catch(o){console.warn("[Rotate] auto play voice-rotate error:",o)}a&&(w==="voice-rotate"&&(m.stop("voice-rotate"),w=null),D&&D.scene&&D.scene.isPaused()&&D.scene.resume(),O&&(console.log(`[Rotate] Ph·ª•c h·ªìi voice b·ªã ng·∫Øt: ${O}`),O==="voice_intro_s2"&&D.restartIntro?D.restartIntro():$(null,O),O=null))}function mt(s){st(),ft(),j(),window.addEventListener("resize",j),window.addEventListener("orientationchange",j)}function it(){w=null,O=null}function St(s){D=s}class yt extends g.Scene{constructor(){super(H.Scene1),this.unfinishedPartsMap=new Map,this.finishedParts=new Set,this.totalParts=0,this.score=0,this.isIntroActive=!1,this.isWaitingForIntroStart=!0,this.activeHintTween=null,this.activeHintTarget=null}get handHint(){return this.scene.get(H.UI)?.handHint}init(t){this.unfinishedPartsMap.clear(),this.finishedParts.clear(),this.totalParts=0,this.score=0,t?.isRestart?(this.isWaitingForIntroStart=!1,t.fromEndGame||u.retryFromStart()):this.isWaitingForIntroStart=!0}create(){if(nt(),this.setupSystem(),this.setupBackgroundAndAudio(),this.createUI(),this.scene.launch(H.UI,{paintManager:this.paintManager,sceneKey:H.Scene1}),this.createLevel(),u.setTotal(1),window.irukaGameState={startTime:Date.now(),currentScore:0},T.score(this.score,0),T.progress({levelIndex:0,total:1}),u.startQuestionTimer(),this.setupInput(),this.events.on("wake",()=>{this.idleManager.reset(),this.input.keyboard&&(this.input.keyboard.enabled=!0)}),!this.isWaitingForIntroStart){const t=this.sound;t.context&&t.context.state==="suspended"&&t.context.resume(),setTimeout(()=>{this.playIntroSequence()},700)}}update(t,e){!this.paintManager.isPainting()&&!this.isIntroActive&&this.finishedParts.size<this.totalParts&&this.idleManager.update(e),this.fpsCounter&&this.fpsCounter.update()}shutdown(){this.stopIntro(),this.paintManager=null,this.scene.stop(H.UI),this.bgm&&this.bgm.stop()}setupSystem(){it(),window.gameScene=this,St(this),this.paintManager=new ut(this,(t,e,i)=>{this.handlePartComplete(t,e,i)}),this.idleManager=new ht(A.IDLE.THRESHOLD,()=>this.showHint())}setupInput(){this.input.on("pointermove",t=>{this.paintManager.handlePointerMove(t),this.paintManager.isPainting()&&(this.idleManager.reset(),this.stopIntro(),this.stopActiveHint())}),this.input.on("pointerup",()=>this.paintManager.handlePointerUp()),this.input.on("pointerdown",()=>{if(this.isWaitingForIntroStart){this.isWaitingForIntroStart=!1;const t=this.sound;t.context&&t.context.state==="suspended"&&t.context.resume(),this.playIntroSequence();return}this.idleManager.reset(),this.stopIntro(),this.stopActiveHint()})}setupBackgroundAndAudio(){dt("assets/images/bg/background.jpg"),this.sound.get(N.BgmNen)&&this.sound.stopByKey(N.BgmNen),this.bgm=this.sound.add(N.BgmNen,{loop:!0,volume:.25}),this.bgm.play()}createUI(){const t=A.SCENE1.UI,e=B.pctX(this,.5),n=this.textures.get(f.S1_Banner).getSourceImage().height*.7+B.pctY(this,t.BOARD_OFFSET),a=this.add.image(e,n,f.S1_Board).setOrigin(.5,0).setScale(.7).setDepth(0),o=a.displayHeight*.7;this.add.rectangle(a.x,a.y+a.displayHeight/2,4,o,0).setOrigin(.5,.5).setDepth(1)}createLevel(){const t=this.cache.json.get(Z.LevelS1Config);t&&t.items&&Array.isArray(t.items)?t.items.forEach((e,i)=>{let n={...e};e.type&&t.definitions&&t.definitions[e.type]&&(n={...t.definitions[e.type],...e}),this.spawnCharacter(n,i)}):t&&(t.parts?this.spawnCharacter(t,0):Object.values(t).forEach((e,i)=>{e&&e.parts&&this.spawnCharacter(e,i)}))}spawnCharacter(t,e=0){const i=B.pctX(this,t.baseX_pct),n=B.pctY(this,t.baseY_pct);if(t.isStatic){this.add.image(i,n,t.outlineKey).setScale(t.baseScale).setDepth(900);return}t.parts.forEach((a,o)=>{const r=`${e}_${a.key}_${o}`,d=i+a.offsetX,p=n+a.offsetY,c=this.paintManager.createPaintableLayer(d,p,a.key,a.scale,r),l=B.calculateCenteredOffset(this,a.key);let S=l.x,h=l.y;c.setData("hintX",S),c.setData("hintY",h),c.setData("originScale",a.scale),typeof t.ans<"u"&&c.setData("isCorrectAnswer",t.ans),a.hintPoints&&Array.isArray(a.hintPoints)&&c.setData("hintPoints",a.hintPoints),this.unfinishedPartsMap.set(r,c),this.totalParts++}),this.add.image(i,n,t.outlineKey).setScale(t.baseScale).setDepth(900).setInteractive({pixelPerfect:!0})}handlePartComplete(t,e,i){if(this.unfinishedPartsMap.get(t)?.getData("isCorrectAnswer")===!1){u.recordWrong(),console.log("WRONG ANSWER!"),m.play("sfx-wrong"),e.clear(),e.setData("isFinished",!1),this.tweens.add({targets:e,x:"+=10",duration:50,yoyo:!0,repeat:3});return}if(this.finishedParts.add(t),u.recordCorrect({scoreDelta:1}),this.score+=1,window.irukaGameState.currentScore=this.score,T.score(this.score,1),T.progress({levelIndex:0,score:this.score}),u.finishQuestionTimer(),i.size===1){const r=i.values().next().value||0;e.setBlendMode(g.BlendModes.NORMAL),e.fill(r)}else console.log("Multi-color artwork preserved!");this.unfinishedPartsMap.delete(t),m.stopAll(),m.play("sfx-ting"),this.tweens.add({targets:e,alpha:.8,yoyo:!0,duration:A.SCENE1.TIMING.AUTO_FILL,repeat:2});let o=0;if(this.unfinishedPartsMap.forEach(r=>{r.getData("isCorrectAnswer")===!0&&o++}),o===0){console.log("WIN!"),u.finalizeAttempt(),T.requestSave({score:this.score,levelIndex:0}),T.progress({levelIndex:0,total:1,score:this.score}),m.play("sfx-correct");const r=this.scene.get(H.UI);r&&(r.hidePalette&&r.hidePalette(),r.hideBanners&&r.hideBanners()),this.time.delayedCall(A.SCENE1.TIMING.WIN_DELAY,()=>{this.scene.start(H.EndGame)})}}restartIntro(){this.stopIntro(),this.time.delayedCall(A.SCENE1.TIMING.RESTART_INTRO,()=>this.playIntroSequence())}playIntroSequence(){this.isIntroActive=!0,$(null,"voice_intro_s2"),this.time.delayedCall(A.SCENE1.TIMING.INTRO_DELAY,()=>{this.isIntroActive&&this.runHandTutorial()})}stopIntro(){this.isIntroActive=!1,this.idleManager.start(),this.handHint&&this.handHint.setAlpha(0).setPosition(-200,-200)}runHandTutorial(){if(!this.isIntroActive)return;const t=Array.from(this.unfinishedPartsMap.values());if(t.sort((a,o)=>a.x-o.x),t.length===0||!this.handHint)return;const e=B.getW(this)+200,i=B.getH(this)+200;this.handHint.setDepth(2e3).setAlpha(1).setScale(.7),this.handHint.setPosition(e,i),this.handHint.setOrigin(0,0);const n=[];t.forEach((a,o)=>{const r=a.getData("hintX")||0,d=a.getData("hintY")||0,p=a.getData("originScale")||1,c=a.x+r*p,l=a.y+d*p;n.push({x:c,y:l,duration:o===0?800:500,ease:"Power2"}),n.push({x:c+40,y:l+20,duration:200,yoyo:!0,repeat:3,ease:"Sine.easeInOut"})}),n.push({alpha:0,duration:500,delay:200,onComplete:()=>{this.handHint?.setPosition(e,i)}}),this.tweens.chain({targets:this.handHint,tweens:n,onComplete:()=>{this.isIntroActive&&this.time.delayedCall(1500,()=>this.runHandTutorial())}})}showHint(){u.addHint();const t=Array.from(this.unfinishedPartsMap.values());if(t.length===0)return;const e=t.filter(_=>_.getData("isCorrectAnswer")===!0);let i;e.length>0?i=e[Math.floor(Math.random()*e.length)]:i=t[Math.floor(Math.random()*t.length)],m.play("hint");const n=A.IDLE;this.activeHintTarget=i,this.activeHintTween=this.tweens.add({targets:i,alpha:{from:.01,to:.8},scale:{from:i.getData("originScale"),to:i.getData("originScale")*1.005},duration:n.FADE_IN,yoyo:!0,repeat:2,onComplete:()=>{this.activeHintTween=null,this.activeHintTarget=null,this.idleManager.reset()}});const a=i.getData("hintX")||0,o=i.getData("hintY")||0,r=i.getData("originScale")||1;let d=i.x+a*r,p=i.y+o*r;if(!this.handHint)return;this.handHint.setOrigin(0,0);const c=i?.getData("hintPoints");let l=d,S=p;const h=[];if(c&&c.length>0){const _=i?.x||0,v=i?.y||0,P=c[0];l=_+P.x*r,S=v+P.y*r,h.push({alpha:1,x:l,y:S,duration:n.FADE_IN}),h.push({scale:.5,duration:n.SCALE,yoyo:!0,repeat:3});for(let k=1;k<c.length;k++){const U=c[k],F=_+U.x*r,W=v+U.y*r;h.push({x:F,y:W,duration:n.SCALE*2}),h.push({scale:.5,duration:n.SCALE,yoyo:!0,repeat:3})}h.push({alpha:0,duration:n.FADE_OUT})}else l=d,S=p,h.push({alpha:1,x:d,y:p,duration:n.FADE_IN}),h.push({scale:.5,duration:n.SCALE,yoyo:!0,repeat:3}),h.push({alpha:0,duration:n.FADE_OUT});this.handHint.setPosition(l,S).setAlpha(0).setScale(.7),this.tweens.chain({targets:this.handHint,tweens:h})}stopActiveHint(){this.activeHintTween&&(this.activeHintTween.stop(),this.activeHintTween=null),this.activeHintTarget&&(this.tweens.killTweensOf(this.activeHintTarget),this.activeHintTarget.setAlpha(.01),this.activeHintTarget.setScale(this.activeHintTarget.getData("originScale")),this.activeHintTarget=null),this.handHint&&(this.tweens.killTweensOf(this.handHint),this.handHint.setAlpha(0).setPosition(-200,-200))}}class wt extends g.Scene{constructor(){super(H.Preload)}preload(){this.load.image(f.BtnExit,"assets/images/ui/btn_exit.png"),this.load.image(f.BtnReset,"assets/images/ui/btn_reset.png"),this.load.image(f.HandHint,"assets/images/ui/hand.png"),this.load.image(f.S1_Banner,"assets/images/S1/banner.png"),this.load.image(f.S1_BannerText,"assets/images/S1/questionTitle.png"),this.load.image(f.S1_Board,"assets/images/bg/board_scene_2.png"),this.load.image(f.S1_Outline,"assets/images/S1/outline.png"),this.load.image(f.S1_1,"assets/images/S1/1.png"),this.load.image(f.S1_Q1,"assets/images/S1/q1.png"),this.load.image(f.S1_Q2,"assets/images/S1/q2.png"),this.load.image(f.S1_Q3,"assets/images/S1/q3.png"),this.load.image(f.S1_Q4,"assets/images/S1/q4.png"),this.load.json(Z.LevelS1Config,"assets/data/level_s1_config.json"),this.load.image(f.End_Icon,"assets/images/ui/icon_end.png"),this.load.image(f.End_BannerCongrat,"assets/images/bg/banner_congrat.png"),this.load.audio(N.BgmNen,"assets/audio/sfx/nhac_nen.mp3")}create(){this.scene.start(H.Scene1)}}class _t extends g.Scene{constructor(){super(H.UI),this.paletteButtons=[]}init(t){this.paintManager=t.paintManager,this.sceneKey=t.sceneKey,this.paletteButtons=[]}create(){this.createUI()}createUI(){const t=A.SCENE1.UI,e=B.pctX(this,.5),i=B.pctY(this,t.BANNER_Y);B.pctX(this,t.BOARD_OFFSET);let n=f.S1_Banner,a=f.S1_BannerText;this.bannerImage=this.add.image(e,i,n).setScale(.9,.7).setOrigin(.5,-.1),this.bannerText=this.add.image(e,i,a).setScale(.9).setOrigin(.5,-1),this.handHint=this.add.image(0,0,f.HandHint).setDepth(2e3).setAlpha(0).setScale(.7),this.createPalette()}createPalette(){const t=A.PALETTE_DATA;t.length>0&&this.paintManager.setColor(t[0].color)}updatePaletteVisuals(t){this.paletteButtons.forEach(e=>e.setScale(.7).setAlpha(.8)),t.setScale(.9).setAlpha(1)}hidePalette(){this.tweens.add({targets:this.paletteButtons,scale:0,alpha:0,duration:500,ease:"Back.In"})}hideBanners(){this.bannerImage&&this.bannerImage.destroy(),this.bannerText&&this.bannerText.destroy(),this.decorImage&&this.decorImage.destroy(),this.so1Image&&this.so1Image.destroy(),this.diceImage&&this.diceImage.destroy()}}class vt extends g.Scene{constructor(){super("EndGameScene"),this.containerEl=null}preload(){this.load.image("icon","assets/images/ui/icon_end.png"),this.load.image("banner_congrat","assets/images/bg/banner_congrat.png"),this.load.image("btn_reset","assets/images/ui/btn_reset.png"),this.load.image("btn_exit","assets/images/ui/btn_exit.png")}create(){it();const t=this.scale.width,e=this.scale.height;if(m.loadAll(),m.play("complete"),this.time.delayedCall(1500,()=>{m.play("fireworks"),m.play("applause")}),this.add.image(t/2,e/2-e*.12,"banner_congrat").setOrigin(.5).setDepth(100).setDisplaySize(t*.9,e*.9),this.textures.exists("icon")){const r=this.add.image(t/2,e/2-150,"icon");r.setScale(.5),r.setDepth(1005),this.tweens.add({targets:r,y:r.y-10,duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.tweens.add({targets:r,angle:{from:-5,to:5},duration:600,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}const i=Math.min(t,e)/1280,n=250*i,a=this.add.image(t/2-n,e/2+e*.2,"btn_reset").setOrigin(.5).setScale(i).setDepth(101).setInteractive({useHandCursor:!0});a.on("pointerdown",()=>{this.time.removeAllEvents(),this.sound.stopAll(),m.stopAll(),m.play("sfx-click"),this.stopConfetti(),nt(),u.retryFromStart(),this.scene.start("Scene1",{isRestart:!0,fromEndGame:!0})});const o=this.add.image(t/2+n,e/2+e*.2,"btn_exit").setOrigin(.5).setScale(i).setDepth(101).setInteractive({useHandCursor:!0});o.on("pointerdown",()=>{m.play("sfx-click"),m.stopAll(),this.stopConfetti();const r=window.irukaGameState||{};r.startTime&&Date.now()-r.startTime,T.complete({timeMs:Date.now()-(window.irukaGameState?.startTime??Date.now()),extras:{reason:"user_exit",stats:u.prepareSubmitData()}})}),[a,o].forEach(r=>{r.on("pointerover",()=>r.setScale(i*1.1)),r.on("pointerout",()=>r.setScale(i))}),at(),this.createConfettiEffect()}createConfettiEffect(){const t=this.cameras.main.width,e=[16739179,5164484,16770669,9822675,15958401,11179738],i=["circle","rect"];this.confettiEvent=this.time.addEvent({delay:100,callback:()=>{if(this.scene.isActive())for(let n=0;n<3;n++)this.createConfettiPiece(g.Math.Between(0,t),-20,g.Utils.Array.GetRandom(e),g.Utils.Array.GetRandom(i))},loop:!0})}createConfettiPiece(t,e,i,n){let a;n==="circle"?a=this.add.circle(t,e,g.Math.Between(4,8),i,1):a=this.add.rectangle(t,e,g.Math.Between(6,12),g.Math.Between(10,20),i,1),a.setDepth(999),a.setRotation(g.Math.Between(0,360)*Math.PI/180);const o=g.Math.Between(3e3,5e3),r=this.cameras.main.height+50,d=g.Math.Between(-100,100);this.tweens.add({targets:a,y:r,x:t+d,rotation:a.rotation+g.Math.Between(2,4)*Math.PI,duration:o,ease:"Linear",onComplete:()=>a.destroy()}),this.tweens.add({targets:a,alpha:{from:1,to:.3},duration:o,ease:"Cubic.easeIn"})}stopConfetti(){this.confettiEvent&&(this.confettiEvent.remove(!1),this.confettiEvent=void 0)}}function It(){const t=(new URLSearchParams(window.location.search).get("e2e")||"").toLowerCase();return t==="1"||t==="true"}function V(s,t=1){const e=Number(s);return!Number.isFinite(e)||e<=0?t:Math.floor(e)}function bt(s){if(!It())return;const t=lt;t?.enable&&(t.enable(),window.__irukaSpy=t);const e=performance.now();window.__irukaTest={setTotal(i){u.setTotal(i)},startQ(i=1){for(let n=0;n<i;n++)u.startQuestionTimer()},finishQ(i=1){for(let n=0;n<i;n++)u.finishQuestionTimer()},makeWrong(i=1){i=V(i,1);for(let n=0;n<i;n++)u.recordWrong()},makeCorrect(i=1){i=V(i,1);for(let a=0;a<i;a++)u.recordCorrect({scoreDelta:1});const n=u.getStatsSnapshot();s.score(n.finalScore)},useHint(i=1){i=V(i,1);for(let n=0;n<i;n++)u.addHint()},finish(){u.finalizeAttempt();const i=u.prepareSubmitData(),n=Math.round(performance.now()-e);s.complete({score:i.finalScore,timeMs:n,extras:i})},snapshot(){return{stats:u.getStatsSnapshot(),submit:u.prepareSubmitData(),spySummary:t?.getSummary?.()}}}}function xt(s,t){const e=document.getElementById("game-container");e&&(e.style.width=`${s}px`,e.style.height=`${t}px`),x&&x.scale.resize(s,t)}function At(s){if(!x)return;x.scene.getScenes(!0)[0]?.applyHubState?.(s)}function Et(){const t=new URLSearchParams(window.location.search).get("hubOrigin");if(t)return t;try{const e=document.referrer;if(e)return new URL(e).origin}catch{}return"*"}let x;const T=u.createGameSdk({hubOrigin:Et(),onInit(s){T.ready({capabilities:["resize","score","complete","save_load","set_state","stats","hint"]})},onStart(){x&&(x.scene.resume("Scene1"),x.scene.resume("EndGameScene"))},onPause(){x&&x.scene.pause("Scene1")},onResume(){x&&x.scene.resume("Scene1")},onResize(s){xt(s.width,s.height)},onSetState(s){At(s)},onQuit(){u.finalizeAttempt("quit"),T.complete({timeMs:Date.now()-(window.irukaGameState?.startTime??Date.now()),extras:{reason:"hub_quit",stats:u.prepareSubmitData()}})}});bt(T);const Ct={type:g.AUTO,width:1920,height:1080,parent:"game-container",scene:[wt,yt,vt,_t],backgroundColor:"#ffffff",scale:{mode:g.Scale.FIT,autoCenter:g.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{debug:!1}},render:{transparent:!0}};x=new g.Game(Ct);function nt(){const s=document.getElementById("btn-reset");s&&(s.style.display="block")}function at(){const s=document.getElementById("btn-reset");s&&(s.style.display="none")}function J(){const s=document.getElementById("btn-reset");if(!s)return;const e=window.innerHeight/9;s.style.width=`${e}px`,s.style.height=`${e}px`}function Dt(){const s=document.getElementById("btn-reset");s&&(s.onclick=()=>{console.log("Restart button clicked."),x.sound.stopByKey("bgm-nen"),m.stopAll();try{m.play("sfx-click")}catch(t){console.error(t)}window.gameScene&&window.gameScene.scene&&(window.gameScene.scene.stop(),window.gameScene.scene.start("Scene1",{isRestart:!0})),at()})}mt();Dt();J();window.addEventListener("resize",J);window.addEventListener("orientationchange",J);document.getElementById("btn-reset")?.addEventListener("sfx-click",()=>{window.gameScene?.scene.restart()});
